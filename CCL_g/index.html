<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <base target="_top">
  <title>ã¡ã‚ƒãƒãƒ£ãƒƒãƒˆLite</title>
  <style>
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
      background: #000;
      color: #fff;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-20px); }
      10% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .chat-container {
      position: relative;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 640px;
      height: calc(100vh - 60px);
      margin: 60px auto 0;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 20px;
      box-sizing: border-box;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      z-index: 1;
    }

    #character-bg {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      height: 100%;
      object-fit: contain;
      object-position: top center;
      opacity: 0.2;
      pointer-events: none;
      z-index: 0;
    }

    .messages {
      flex-grow: 1;
      overflow-y: auto;
      max-height: 100%;
      margin-bottom: 1rem;
      padding-right: 0.5rem;
      padding-top: 10px;
      position: relative;
      z-index: 2;
      scrollbar-width: thin;
      scrollbar-color: #666 transparent;
    }

    .messages::-webkit-scrollbar {
      width: 8px;
    }

    .messages::-webkit-scrollbar-thumb {
      background: #666;
      border-radius: 8px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .message {
      margin: 0.5rem 0;
    }

    .bubble {
      display: inline-block;
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.4;
      white-space: pre-wrap;
      opacity: 0.85;
      word-break: break-word;
      overflow-wrap: break-word;
      overflow: visible;
    }

    .user {
      text-align: right;
    }

    .user .bubble {
      background: rgba(102, 102, 102, 0.7);
      color: #fff;
      text-align: left;
    }

    .assistant .bubble {
      background: rgba(68, 68, 68, 0.7);
      color: #fff;
    }

    .input-area {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
      position: relative;
      z-index: 2;
      margin-bottom: 20px;
    }

    textarea {
      flex-grow: 1;
      resize: none;
      padding: 0.75rem;
      border: 1px solid #666;
      border-radius: 10px;
      font-size: 1rem;
      background: #222;
      color: #fff;
    }

    button {
      padding: 0.6rem 1.2rem;
      border: none;
      background: #444;
      color: white;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #555;
    }

    #settings {
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 1rem;
      margin: 1rem auto;
      border-radius: 16px;
      display: none;
      max-width: 640px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    #settings::-webkit-scrollbar {
      width: 8px;
    }

    #settings::-webkit-scrollbar-thumb {
      background: #666;
      border-radius: 8px;
    }

    #settings::-webkit-scrollbar-track {
      background: transparent;
    }

    .settings-toggle {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #444;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      z-index: 10;
    }

    .quick-action {
      position: fixed;
      top: 15px;
      right: 70px;
      background: #444;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      z-index: 10;
      user-select: none;
    }

    /* è¨­å®šç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .settings-section {
      background: #222;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .section-header {
      margin-bottom: 1.5rem;
    }

    .section-header h3 {
      color: #fff;
      margin: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      color: #aaa;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      background: #333;
      border: 1px solid #444;
      border-radius: 6px;
      color: #fff;
      font-size: 0.9rem;
    }

    .form-textarea {
      width: 100%;
      min-height: 120px;
      padding: 0.75rem;
      background: #333;
      border: 1px solid #444;
      border-radius: 6px;
      color: #fff;
      font-size: 0.9rem;
      resize: vertical;
    }

    .form-file {
      width: 100%;
      padding: 0.5rem;
      background: #333;
      border: 1px solid #444;
      border-radius: 6px;
      color: #fff;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }

    .toggle-label {
      color: #aaa;
      font-size: 0.9rem;
    }

    .dev-section {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .btn {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: #4f80ff;
      color: white;
    }

    .btn-secondary {
      background: #666;
      color: white;
    }

    .btn-danger {
      background: #ff4d4d;
      color: white;
    }

    .settings-footer {
      margin-top: 2rem;
      text-align: right;
    }

    .token-usage {
      color: #ccc;
    }

    .token-usage h4 {
      margin: 0 0 1rem;
      color: #fff;
      font-size: 1rem;
    }

    .token-stats {
      display: grid;
      gap: 1rem;
      margin: 1rem 0;
    }

    .stat-item label {
      display: block;
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .stat-value {
      font-size: 1.1rem;
      color: #fff;
    }

    .token-period {
      color: #888;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    .input-group {
      display: flex;
      align-items: center;
    }

    /* é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .dev-toggle-container {
      margin-bottom: 1rem;
      text-align: left;
      padding-top: 0;
    }

    .dev-toggle-container .btn {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      opacity: 0.8;
    }

    .dev-toggle-container .btn:hover {
      opacity: 1;
    }

    /* é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .dev-toggle-container .btn.active {
      background: #4f80ff;
      opacity: 1;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘èª¿æ•´ */
    @media (max-width: 640px) {
      body {
        padding-top: 50px;
      }
      
      .chat-container {
        width: 100%;
        height: calc(100vh - 70px);
        margin-top: 10px;
        border-radius: 10px;
        padding: 0.5rem;
      }
      
      textarea {
        font-size: 16px;
      }
      
      .bubble {
        max-width: 80%;
      }
      
      .messages {
        padding-top: 10px;
      }
      
      .settings-toggle {
        top: 10px;
        right: 10px;
      }
      
      .quick-action {
        top: 10px;
        right: 70px;
      }
      
      .input-area {
        margin-bottom: 40px;
      }
    }

    /* ãƒ‡ãƒ¼ã‚¿é–²è¦§ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .data-viewer-toggle {
      position: fixed;
      top: 60px;
      right: 15px;
      background: #444;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      z-index: 10;
    }

    /* ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .data-viewer-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      overflow: auto;
    }

    .data-viewer-content {
      position: relative;
      width: 80%;
      max-width: 800px;
      margin: 50px auto;
      padding: 2rem;
      background: #222;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .data-viewer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #444;
    }

    .data-viewer-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .data-category {
      margin-bottom: 2rem;
    }

    .data-category-title {
      color: #aaa;
      font-size: 1.1rem;
      margin-bottom: 0.8rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #333;
    }

    .data-item {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: #333;
      border-radius: 6px;
    }

    .data-key {
      color: #66aaff;
      font-weight: bold;
      margin-bottom: 0.3rem;
    }

    .data-value {
      color: #ddd;
      word-break: break-all;
      white-space: pre-wrap;
      background: #2a2a2a;
      padding: 0.5rem;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }

    .data-value-editor {
      width: 100%;
      min-height: 100px;
      max-height: 300px;
      padding: 0.5rem;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      font-family: monospace;
      resize: vertical;
    }

    .data-edit-controls {
      display: flex;
      justify-content: flex-end;
      margin-top: 0.5rem;
      gap: 0.5rem;
    }

    .data-edit-btn {
      padding: 0.3rem 0.8rem;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .data-edit-save {
      background: #4f80ff;
      color: white;
    }

    .data-edit-cancel {
      background: #666;
      color: white;
    }

    .data-viewer-mode-switch {
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .mode-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #333;
      color: #fff;
    }

    .mode-btn.active {
      background: #4f80ff;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘èª¿æ•´ã‚’è¿½åŠ  */
    @media (max-width: 640px) {
      .data-viewer-toggle {
        top: 60px;
        right: 10px;
      }
      
      .data-viewer-content {
        width: 95%;
        margin: 30px auto;
        padding: 1rem;
      }
      
      .data-viewer-modal {
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        position: fixed;
        overflow-x: hidden;
      }
      
      .data-item {
        overflow-x: hidden;
      }
      
      .data-value {
        max-width: 100%;
        overflow-x: auto;
      }
      
      .data-value-editor {
        max-width: 100%;
      }
    }

    .story-intensity-btn {
      padding: 0.4rem 0.8rem;
      background: #333;
      color: #ccc;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .story-intensity-btn:hover {
      background: #444;
    }
    
    .story-intensity-btn.active {
      background: #4f80ff;
      color: white;
    }

    /* ãƒ•ã‚©ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .photo-mode-toggle {
      position: fixed;
      top: 15px;
      right: 125px;
      background: #444;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      z-index: 10;
    }
    
    /* æ—¢çŸ¥æƒ…å ±ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .known-facts-toggle {
      position: fixed;
      top: 15px;
      right: 185px;
      background: #444;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      z-index: 10;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
      display: none;
      position: fixed;
      z-index: 20;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }
    
    .modal-content {
      background-color: #222;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #444;
      border-radius: 10px;
      width: 80%;
      max-width: 800px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #eee;
    }
    
    .modal-footer {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: #fff;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘èª¿æ•´ */
    @media (max-width: 640px) {
      .photo-mode-toggle {
        top: 10px;
        right: 125px;
      }
      
      .known-facts-toggle {
        top: 10px;
        right: 185px;
      }
      
      .modal-content {
        width: 95%;
        margin: 5% auto;
      }
    }
    
    /* ãƒ•ã‚©ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .photo-mode .bubble {
      display: none !important;
    }
    
    .photo-mode .message {
      margin: 0 !important;
      padding: 0 !important;
    }
    
    .photo-mode .input-area {
      display: none !important;
    }
    
    .photo-mode #character-bg {
      opacity: 1 !important;
      object-fit: contain !important;
    }
  </style>
</head>

<body>
  <!-- ğŸ›  æœ€æ–°æ“ä½œãƒœã‚¿ãƒ³ -->
  <div class="quick-action" onclick="toggleQuickActions()">ğŸ”§</div>

  <!-- ğŸ“· ãƒ•ã‚©ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
  <div class="photo-mode-toggle" onclick="togglePhotoMode()">ğŸ“·</div>

  <!-- ğŸ“„ ãƒ‡ãƒ¼ã‚¿é–²è¦§ãƒœã‚¿ãƒ³ -->
  <div class="data-viewer-toggle" onclick="toggleDataViewer()">ğŸ“„</div>

  <!-- ğŸ“— æ—¢çŸ¥æƒ…å ±ãƒœã‚¿ãƒ³ -->
  <div class="known-facts-toggle" onclick="toggleKnownFactsModal()">ğŸ“—</div>

  <!-- ğŸ“— æ—¢çŸ¥æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="knownFactsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>ğŸ“— ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¤ã„ã¦çŸ¥ã£ã¦ã„ã‚‹æƒ…å ±</h3>
        <span class="close" onclick="toggleKnownFactsModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 1rem;">
          ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¨­å®šã®ã†ã¡ã€ã‚ãªãŸãŒæ—¢ã«çŸ¥ã£ã¦ã„ã‚‹æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
          ã“ã®æƒ…å ±ã¯åœ°ã®æ–‡ã«å«ã‚ã¦ã‚‚è‰¯ã„æƒ…å ±ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
        </p>
        <textarea id="knownFactsInput" class="form-textarea" style="min-height: 150px;" 
                  placeholder="ä¾‹ï¼šå½¼å¥³ã¯åŒ»è€…ã§ã‚ã‚‹ã“ã¨ã€é­”æ³•ãŒä½¿ãˆã‚‹ã“ã¨ã€ã‚±ãƒ¼ã‚­ãŒå¥½ããªã“ã¨..."></textarea>
      </div>
      <div class="modal-footer">
        <button onclick="saveKnownFacts()" class="btn btn-primary">ä¿å­˜</button>
        <button onclick="toggleKnownFactsModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ğŸ§© æœ€æ–°æ“ä½œãƒ‘ãƒãƒ« -->
  <div id="quickActionsPanel" style="
  display:none;
  position: fixed;
  top: 45px;
  left: 15px;
  background: #111;
  border: 1px solid #555;
  border-radius: 10px;
  padding: 0.8rem;
  font-size: 0.85rem;
  z-index: 4;
  box-shadow: 0 4px 12px rgba(0,0,0,0.6);
">
    <b style="color:#ccc;">æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ“ä½œ</b><br><br>
    <button onclick="handleQuickAction('save')" style="margin-bottom:0.5rem;">ğŸ’¾ è¨˜æ†¶</button><br>
    <button onclick="handleQuickAction('editBot')" style="margin-bottom:0.5rem;">âœï¸ ä¿®æ­£ï¼ˆã‚­ãƒ£ãƒ©ï¼‰</button><br>
    <button onclick="handleQuickAction('editUser')" style="margin-bottom:0.5rem;">âœï¸ ä¿®æ­£ï¼ˆè‡ªåˆ†ï¼‰</button><br>
    <button onclick="handleQuickAction('editLastMessage')" style="margin-bottom:0.5rem;">âœï¸ æœ€æ–°ä¿®æ­£</button><br>
    <button onclick="handleQuickAction('regen')" style="margin-bottom:0.5rem;">ğŸ” å†ç”Ÿæˆ</button><br>
  </div>

  <div class="settings-toggle" onclick="toggleSettings()">âš™ï¸ </div>
  <div id="settings">
    <!-- é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ« -->
    <div class="dev-toggle-container" style="display:none;">
      <!-- é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã¯è¨­å®šãƒ•ãƒƒã‚¿ãƒ¼ã«ç§»å‹•ã—ãŸãŸã‚éè¡¨ç¤º -->
    </div>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ï¼šã‚­ãƒ£ãƒ©è¨­å®š -->
    <div class="settings-section">
      <div class="section-header">
        <h3>ğŸ‘¤ ã‚­ãƒ£ãƒ©è¨­å®š</h3>
      </div>
      <div class="section-content">
        <div class="form-group">
          <label>ã‚­ãƒ£ãƒ©è¨­å®šï¼ˆåˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰</label>
          <textarea id="charPrompt" class="form-textarea" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è©³ç´°ãªè¨­å®šã‚’è¨˜è¿°ã—ã¦ãã ã•ã„">åå‰ï¼šæ€§åˆ¥ã€ç‰¹å¾´</textarea>
        </div>
        <div class="form-group">
          <label>ğŸ–¼ï¸ èƒŒæ™¯ç”»åƒ</label>
          <div style="position: relative;">
            <input type="file" id="backgroundInput" accept="image/*">
            <div id="selectedFileInfo" style="margin-top: 0.5rem; font-size: 0.85rem; color: #aaa;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š -->
    <div class="settings-section">
      <div class="section-header">
        <h3>ğŸ™‹ ã‚ãªãŸã®è¨­å®š</h3>
      </div>
      <div class="section-content">
        <div class="form-group">
          <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</label>
          <input type="text" id="charSelfSetting" class="form-input" placeholder="">
        </div>
        <div class="form-group">
          <label class="toggle-switch">
            <input type="checkbox" id="storyModeToggle" onchange="updateStoryMode()">
            <span class="toggle-label">ğŸ“– ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰</span>
          </label>
          <div id="storyModeInfo" style="display: none; margin-top: 0.5rem; font-size: 0.8rem; color: #aaa; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 6px;">
            ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚»ãƒªãƒ•ã¨åœ°ã®æ–‡ãŒäº¤äº’ã«æ§‹æˆã•ã‚ŒãŸã€å°èª¬ã®ã‚ˆã†ãªè¡¨ç¾ã«ãªã‚Šã¾ã™ã€‚åœ°ã®æ–‡ãŒå¤šã‚ã®æå†™å¯„ã‚Šã®æ§‹æˆã§ã€ã‚ˆã‚Šç‰©èªçš„ãªé›°å›²æ°—ãŒæ¥½ã—ã‚ã¾ã™ã€‚
          </div>
          
          <!-- ç‰©èªãƒ¢ãƒ¼ãƒ‰æ¿ƒåº¦åˆ‡æ›¿ -->
          <div id="storyIntensitySelector" style="display: none; margin-top: 0.8rem;">
            <label style="display: block; margin-bottom: 0.4rem; color: #bbb; font-size: 0.9rem;">ç‰©èªæ¿ƒåº¦</label>
            <div style="display: flex; gap: 0.5rem;">
              <button id="intensityMedium" class="story-intensity-btn active" onclick="setStoryIntensity('medium')">ãƒŸãƒ‰ãƒ«</button>
              <button id="intensityHigh" class="story-intensity-btn" onclick="setStoryIntensity('high')">ãƒã‚¤</button>
            </div>
            <div id="intensityInfo" style="margin-top: 0.5rem; font-size: 0.8rem; color: #aaa; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
              ãƒŸãƒ‰ãƒ«ï¼š400æ–‡å­—ç¨‹åº¦ã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸç‰©èªæå†™
            </div>
            
            <!-- ã‚­ãƒ£ãƒ©ãŒã‚¹ãƒˆãƒ¼ãƒªãƒ¼å±•é–‹ã‚’ãƒªãƒ¼ãƒ‰ã™ã‚‹ç¢ºç‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
            <div style="margin-top: 1rem; display: block;">
              <label style="display: block; margin-bottom: 0.4rem; color: #bbb; font-size: 0.9rem;">
                ã‚­ãƒ£ãƒ©ãŒç‰©èªã‚’ãƒªãƒ¼ãƒ‰ã™ã‚‹ç¢ºç‡
              </label>
              <div style="display: flex; align-items: center; gap: 0.8rem;">
                <input type="range" id="storyLeadSlider" min="0" max="100" step="5" value="75" 
                       style="flex-grow: 1;" oninput="updateStoryLeadProbability(this.value)">
                <span id="storyLeadValue" style="color: #4f80ff; font-weight: bold; min-width: 3rem; text-align: right;">75%</span>
              </div>
              <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #aaa; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                é«˜ã„å€¤ã»ã©ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæ–°ã—ã„å ´æ‰€ã‚„è©±é¡Œã‚’ç©æ¥µçš„ã«ææ¡ˆã—ã¾ã™
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="toggle-switch">
            <input type="checkbox" id="resetEmotionToggle">
            <span class="toggle-label">ğŸ”„ æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹</span>
          </label>
          <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #aaa; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 6px;">
            ONã«ã™ã‚‹ã¨è¨­å®šå¤‰æ›´æ™‚ã«æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿ã‚’å†è¨ˆç®—ã—ã¾ã™ã€‚OFFã«ã™ã‚‹ã¨ç¾åœ¨ã®æ„Ÿæƒ…å€¤ã‚’ãã®ã¾ã¾ç¶­æŒã—ã¾ã™ã€‚ï¼ˆåˆæœŸè¨­å®šï¼šOFFï¼‰
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ï¼šé–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ -->
    <div id="devMode" class="settings-section" style="display: none;">
      <div class="section-header">
        <h3>ğŸ› ï¸ é–‹ç™ºè€…è¨­å®š</h3>
        <label class="toggle-switch">
          <input type="checkbox" id="debugToggle" onchange="updateDebugMode()">
          <span class="toggle-label">ğŸ§ª ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</span>
        </label>
      </div>

      <!-- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="errorLogArea" class="dev-section" style="display: none;">
        <h4 style="margin-top: 0; color: #ff6b6b;">âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</h4>
        <div id="errorLogContent" style="max-height: 300px; overflow-y: auto; background: #1a1a1a; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; word-break: break-all;">
          ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“
        </div>
        <div style="margin-top: 10px; display: flex; justify-content: space-between;">
          <button onclick="clearErrorLogs()" class="btn btn-secondary" style="font-size: 0.85rem;">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
          <button onclick="copyErrorLogs()" class="btn btn-secondary" style="font-size: 0.85rem;">ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>

      <!-- æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
      <div id="emotionParamsArea" class="dev-section"></div>

      <!-- ã‚­ãƒ£ãƒ©ãƒªã‚»ãƒƒãƒˆ -->
      <div class="dev-section">
        <button onclick="resetCharacterDataClientOnly()" class="btn btn-danger">
          âš ï¸ ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        </button>
        <div style="font-size: 0.8rem; color: #aaa; margin-top: 0.5rem;">
          ä¼šè©±å±¥æ­´ãƒ»è¨˜æ†¶ãƒ»æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿ãªã©ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚APIã‚­ãƒ¼ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚
        </div>
        
        <button onclick="resetMessagesOnly()" class="btn btn-warning" style="margin-top: 1rem;">
          ğŸ—‘ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ãƒªã‚»ãƒƒãƒˆ
        </button>
        <div style="font-size: 0.8rem; color: #aaa; margin-top: 0.5rem;">
          ä¼šè©±å±¥æ­´ã¨æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿ã®ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚­ãƒ£ãƒ©è¨­å®šãƒ»ç”»åƒãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã¯ä¿æŒã•ã‚Œã¾ã™ã€‚
        </div>
      </div>

      <!-- ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨çŠ¶æ³ -->
      <div id="tokenUsageArea" class="dev-section"></div>

      <!-- GPT-4oãƒ­ã‚°è¡¨ç¤º -->
      <div id="gpt4oLogsArea" class="dev-section">
        <h4>ğŸ“ GPT-4o ç‰©èªå±•é–‹ãƒ­ã‚°</h4>
        <div id="gpt4oLogsContent" style="max-height: 300px; overflow-y: auto; background: #1a1a1a; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; word-break: break-all;">
          ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“
        </div>
        <div style="margin-top: 10px; display: flex; justify-content: space-between;">
          <button onclick="clearGpt4oLogs()" class="btn btn-secondary" style="font-size: 0.85rem;">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
          <button onclick="updateGpt4oLogsDisplay()" class="btn btn-secondary" style="font-size: 0.85rem;">æ›´æ–°</button>
        </div>
      </div>

      <!-- APIã‚­ãƒ¼ -->
      <div class="dev-section">
        <div class="form-group">
          <label>ğŸ”‘ GPT APIã‚­ãƒ¼</label>
          <input type="password" id="apiKey" class="form-input" placeholder="sk-...">
        </div>
      </div>
    </div>

    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div class="settings-footer">
      <button id="devToggle" onclick="toggleDevMode()" class="btn btn-secondary" style="float:left; margin-right:1rem;">
        ğŸ›  é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰
      </button>
      <button onclick="saveSettings()" class="btn btn-primary">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
    </div>
  </div>

  <div class="chat-container">
    <img id="character-bg">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <textarea id="userInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1"></textarea>
      <button onclick="try { sendMessage(); } catch(e) { console.error('é€ä¿¡ãƒœã‚¿ãƒ³ã‚¨ãƒ©ãƒ¼:', e); alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e); }">é€ä¿¡</button>
    </div>
  </div>

  <div id="regenerateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: relative; max-width: 500px; margin: 100px auto; padding: 1.5rem; background: #222; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 1rem; color: #fff; font-size: 1rem;">å†ç”Ÿæˆã—ãŸã„å†…å®¹ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰</h3>
      <textarea id="regenPrompt" 
        style="width: 100%; min-height: 100px; padding: 0.75rem; background: #333; color: #fff; border: 1px solid #555; border-radius: 8px; font-size: 0.9rem;"
        placeholder="ä¾‹ï¼šã‚‚ã£ã¨å„ªã—ãè¨€ã£ã¦ã»ã—ã„ï¼ãƒãƒˆãƒ«å±•é–‹ã«ã—ã¦ï¼ã€€ãªã©"></textarea>
      <div style="margin-top: 1rem; text-align: right;">
        <button onclick="document.getElementById('regenerateModal').style.display='none';" style="margin-right: 0.5rem; background: #444;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="executeRegeneration()" style="background: #555;">OK</button>
      </div>
    </div>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="dataViewerModal" class="data-viewer-modal">
    <div class="data-viewer-content">
      <div class="data-viewer-header">
        <h3 style="margin: 0; color: #fff; font-size: 1.2rem;">ğŸ“„ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h3>
        <button class="data-viewer-close" onclick="toggleDataViewer()">âœ–</button>
      </div>
      <div class="data-viewer-mode-switch">
        <button id="viewModeBtn" class="mode-btn active" onclick="switchDataViewerMode('view')">é–²è¦§ãƒ¢ãƒ¼ãƒ‰</button>
        <button id="editModeBtn" class="mode-btn" onclick="switchDataViewerMode('edit')">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
      </div>
      <div id="dataViewerContent"></div>
    </div>
  </div>

  <!-- å¾Œã§èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹JSãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <script>
    // GASç’°å¢ƒå‘ã‘ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢æŠ½è±¡åŒ–
    const dataStore = {
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      cache: {},
      
      // ãƒ‡ãƒ¼ã‚¿å–å¾—
      getItem(key) {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
        if (this.cache[key] !== undefined) {
          return this.cache[key];
        }
        
        // éåŒæœŸå–å¾—ã‚’é–‹å§‹
        this._fetchAsync(key);
        
        // åˆå›ã¯ç©ºã‚’è¿”ã™
        return "";
      },
      
      // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
      setItem(key, value) {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
        this.cache[key] = value;
        
        // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
        google.script.run
          .withSuccessHandler(() => {})
          .withFailureHandler((error) => console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error))
          .saveUserData(key, value);
        
        return value;
      },
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ã¿ï¼‰
      setLocalItem(key, value) {
        try {
          localStorage.setItem(key, value);
          
          // ç”»åƒãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯base64æ–‡å­—åˆ—ã‚’cacheã¨ã‚µãƒ¼ãƒãƒ¼ã®ä¸¡æ–¹ã«ä¿å­˜
          if (key === "bgImageData" && value && value.startsWith("data:image")) {
            this.cache["avatar_url"] = value;
            this.setItem("avatar_url", value);
          }
        } catch (e) {
          console.error("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
        }
      },
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
      getLocalItem(key) {
        try {
          return localStorage.getItem(key);
        } catch (e) {
          console.error("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
          return null;
        }
      },
      
      // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
      removeItem(key) {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å‰Šé™¤
        delete this.cache[key];
        
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å‰Šé™¤ï¼ˆç©ºæ–‡å­—åˆ—ã‚’é€ä¿¡ã—ã¦ç¢ºå®Ÿã«å‰Šé™¤ï¼‰
        google.script.run
          .withSuccessHandler(() => {
            console.log(`ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†: ${key}`);
          })
          .withFailureHandler((error) => console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error))
          .saveUserData(key, "");
      },
      
      // éåŒæœŸå–å¾—
      _fetchAsync(key) {
        google.script.run
          .withSuccessHandler((value) => {
            this.cache[key] = value;
            
            // ç‰¹å®šã®ã‚­ãƒ¼ã®å ´åˆã¯è¿½åŠ å‡¦ç†
            if (key === "avatar_url" && value) {
              // èƒŒæ™¯ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜
              this.setLocalItem("bgImageData", value);
              
              // ç”»åƒã®è¡¨ç¤ºã‚’æ›´æ–°
              const bgImage = document.getElementById("character-bg");
              if (bgImage) {
                bgImage.src = value;
              }
            }
            
            // æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
            document.dispatchEvent(new CustomEvent('datastore_updated', {
              detail: { key, newValue: value }
            }));
          })
          .withFailureHandler((error) => console.error("å–å¾—ã‚¨ãƒ©ãƒ¼:", error))
          .getUserData(key);
      },
      
      // å¤‰æ›´ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹é–¢æ•°ï¼ˆGASç‰ˆã§ã¯å€‹åˆ¥ã«å³æ™‚ä¿å­˜ã•ã‚Œã‚‹ãŸã‚å®Ÿè³ªä¸è¦ï¼‰
      flushChanges() {
        // å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã®ãŸã‚ã«ç©ºã®é–¢æ•°ã‚’ç”¨æ„
        console.log("flushChanges called - ã“ã®é–¢æ•°ã¯GASç‰ˆã§ã¯ä¸è¦ã§ã™");
        return;
      },
      
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ãƒ­ãƒ¼ãƒ‰
      initializeFromServer() {
        console.log("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ãƒ­ãƒ¼ãƒ‰ä¸­...");
        google.script.run
          .withSuccessHandler((allData) => {
            if (!allData) {
              console.log("ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
              return;
            }
            
            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            this.cache = { ...allData };
            
            // é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
            this._initializeUI();
            
            console.log("ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ");
          })
          .withFailureHandler((error) => {
            console.error("ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
          })
          .getAllUserData();
      },
      
      // UIã‚’åˆæœŸåŒ–
      _initializeUI() {
        // ã‚­ãƒ£ãƒ©è¨­å®šã®å¾©å…ƒï¼ˆç©ºæ–‡å­—åˆ—ã‚„nullã¯å¾©å…ƒã—ãªã„ï¼‰
        const characterPrompt = this.cache["character_prompt"];
        if (characterPrompt && characterPrompt.trim() !== "") {
          document.getElementById("charPrompt").value = characterPrompt;
        }
        
        // è‡ªå·±è¨­å®šã®å¾©å…ƒï¼ˆç©ºæ–‡å­—åˆ—ã‚„nullã¯å¾©å…ƒã—ãªã„ï¼‰
        const charSelf = this.cache["char_self"];
        if (charSelf && charSelf.trim() !== "") {
          document.getElementById("charSelfSetting").value = charSelf;
        }
        
        // APIã‚­ãƒ¼ã®å¾©å…ƒ
        const apiKey = this.cache["openai_api_key"];
        if (apiKey) {
          document.getElementById("apiKey").value = apiKey;
        }
        
        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®å¾©å…ƒ
        const storyMode = this.cache["story_mode"];
        if (storyMode) {
          document.getElementById("storyModeToggle").checked = storyMode === "1";
        }
        
        // èƒŒæ™¯ç”»åƒã®å¾©å…ƒï¼ˆç©ºæ–‡å­—åˆ—ã‚„nullã¯å¾©å…ƒã—ãªã„ï¼‰
        const avatarUrl = this.cache["avatar_url"];
        if (avatarUrl && avatarUrl.trim() !== "") {
          document.getElementById("character-bg").src = avatarUrl;
          this.setLocalItem("bgImageData", avatarUrl);
        }
        
        // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¡¨ç¤ºæ›´æ–°
        renderEmotionParams();
        
        // ä¼šè©±å±¥æ­´ã®å¾©å…ƒï¼ˆç©ºé…åˆ—ã‚„nullã¯å¾©å…ƒã—ãªã„ï¼‰
        const chatHistory = JSON.parse(this.cache["chat_history"] || "[]");
        if (chatHistory && chatHistory.length > 0) {
          const messagesContainer = document.getElementById("messages");
          messagesContainer.innerHTML = ""; // åˆæœŸåŒ–
          
          // ä¼šè©±å±¥æ­´ã‚’è¡¨ç¤º
          chatHistory.forEach(msg => {
            const msgDiv = document.createElement("div");
            msgDiv.className = `message ${msg.role}`;
            msgDiv.innerHTML = `<div class="bubble">${msg.content}</div>`;
            messagesContainer.appendChild(msgDiv);
          });
          
          // æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      },
      
      // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      getAllData() {
        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã®ã§ã¯ãªãã€ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¿”ã™
        // ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ç”¨ã«ç°¡æ˜“çš„ãªå®Ÿè£…
        return { ...this.cache };
      }
    };

    const model = "gpt-4.1-mini";
    const gpt4oModel = "gpt-4o"; // è¿½åŠ ï¼šGPT-4oãƒ¢ãƒ‡ãƒ«å
    
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–å‡¦ç†
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOMContentLoaded: ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™");
      
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      dataStore.initializeFromServer();
      
      // è¨­å®šã‚¿ãƒ–ã®åˆæœŸåŒ–
      document.querySelector('.tab-header').click();
      
      // é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸè¨­å®š
      if (dataStore.getItem("dev_mode") === "1") {
        document.getElementById("devMode").style.display = "block";
        document.getElementById("devToggle").classList.add("active");
      }
      
      // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸè¨­å®š
      if (dataStore.getItem("debug_mode") === "1") {
        document.getElementById("debugToggle").checked = true;
        updateDebugMode();
      }
      
      console.log("ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ");
    });

    const compressPrompt = `ä»¥ä¸‹ã®é•·æœŸè¨˜æ†¶ã‚’1ã€œ3æ–‡ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚
é‡è¤‡ã¯çµ±åˆã—ã€é‡è¦ãªç‰¹å¾´ã®ã¿æ®‹ã—ã¦ãã ã•ã„ã€‚

å‡ºåŠ›ã¯ä»¥ä¸‹ã®å½¢å¼ã«å¾“ã£ã¦ãã ã•ã„ï¼ˆãã®ä»–ã®å‡ºåŠ›ã¯ç¦æ­¢ï¼‰ï¼š

{
  "summary": "..."
}
`;

    // è¿½åŠ ï¼šä¼šè©±ã®è¦ç´„ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆ200æ–‡å­—åˆ¶é™ï¼‰
    async function getConversationSummary() {
      const apiKey = dataStore.getItem("openai_api_key");
      if (!apiKey) return "";
      
      try {
        // ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        const history = JSON.parse(dataStore.getItem("chat_history") || "[]");
        if (history.length < 3) return ""; // ä¼šè©±ãŒã¾ã å°‘ãªã„å ´åˆã¯è¦ç´„ãªã—
        
        // ç›´è¿‘ã®5ä»¶ã‚’é¸æŠ
        const recentMessages = history.slice(-5).map(m => ({
          role: m.role === "bot" ? "assistant" : m.role,
          content: m.content
        }));
        
        console.log("ä¼šè©±è¦ç´„ã‚’å–å¾—ã—ã¾ã™ - ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", recentMessages.length, "ä»¶");
        
        // GASçµŒç”±ã§ã‚µãƒ¼ãƒãƒ¼å´ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        const data = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getConversationSummary(apiKey, recentMessages);
        });
        
        console.log("ä¼šè©±è¦ç´„çµæœ:", data ? data.substring(0, 50) + "..." : "ãªã—");
        
        return data || "";
      } catch (err) {
        console.error("ä¼šè©±è¦ç´„ã‚¨ãƒ©ãƒ¼:", err);
        return "";
      }
    }

    // è¿½åŠ ï¼šGPT-4oã§æ¬¡ã®ç‰©èªå±•é–‹ã‚’ææ¡ˆã™ã‚‹é–¢æ•°
    async function getNextPlotSuggestion(conversationSummary, userInput) {
      const apiKey = dataStore.getItem("openai_api_key");
      if (!apiKey) return "";
      const characterPrompt = dataStore.getItem("character_prompt") || "";
      
      try {
        // ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        const history = JSON.parse(dataStore.getItem("chat_history") || "[]");
        const recentMessages = history.slice(-3).map(m => ({
          role: m.role === "bot" ? "assistant" : m.role,
          content: m.content
        }));

        console.log("æ¬¡ã®ç‰©èªå±•é–‹ã‚’å–å¾—ã—ã¾ã™:", 
          "ã‚­ãƒ£ãƒ©è¨­å®š:", characterPrompt ? characterPrompt.substring(0, 30) + "..." : "ãªã—", 
          "è¦ç´„:", conversationSummary ? conversationSummary.substring(0, 30) + "..." : "ãªã—",
          "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°:", recentMessages.length);

        // GASçµŒç”±ã§ã‚µãƒ¼ãƒãƒ¼å´ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        const data = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler((result) => {
              console.log("ç‰©èªå±•é–‹ã®çµæœã‚’å—ä¿¡:", result ? result.substring(0, 30) + "..." : "ãªã—");
              resolve(result);
            })
            .withFailureHandler((error) => {
              console.error("ç‰©èªå±•é–‹ã®å–å¾—ã«å¤±æ•—:", error);
              reject(error);
            })
            .getNextPlotSuggestion(apiKey, characterPrompt, conversationSummary, recentMessages);
        });
        
        // GPT-4oã®ãƒ­ã‚°ã‚’ä¿å­˜
        try {
          saveGpt4oLog({ 
            type: "nextPlotSuggestion", 
            summary: conversationSummary, 
            input: userInput 
          }, { suggestion: data });
        } catch (e) {
          console.warn("ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
        }
        
        return data;
      } catch (err) {
        console.error("GPT-4o ç‰©èªå±•é–‹äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:", err);
        return "";
      }
    }

    // GPT-4oãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveGpt4oLog(request, response) {
      try {
        const now = new Date().toISOString();
        const logs = JSON.parse(dataStore.getItem("gpt4o_logs") || "[]");
        
        // æœ€å¤§20ä»¶ã¾ã§ä¿å­˜
        if (logs.length >= 20) {
          logs.shift(); // å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤
        }
        
        logs.push({ 
          date: now, 
          request, 
          response,
          suggestion: response?.choices?.[0]?.message?.content || ""
        });
        
        dataStore.setItem("gpt4o_logs", JSON.stringify(logs));
      } catch (e) {
        console.error("GPT-4oãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
      }
    }

    // GPT-4oã®ãƒ­ã‚°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getGpt4oLogs() {
      return JSON.parse(dataStore.getItem("gpt4o_logs") || "[]");
    }

    // ãƒ¡ãƒ¢ãƒªãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼åˆ¶å¾¡ç”¨ãƒ•ãƒ©ã‚°
    window.allowMemoryIncrement = true;

    function getMemoryCounter() {
      return Number(dataStore.getItem("memory_counter") || "0");
    }
    
    function incMemoryCounter() {
      if (!window.allowMemoryIncrement) return getMemoryCounter();
      let c = getMemoryCounter() + 1;
      dataStore.setItem("memory_counter", c.toString());
      return c;
    }

    // é•·æœŸè¨˜æ†¶ã®æœ€å¾Œã®1ä»¶ã‚’å‰Šé™¤
    function removeLastMemory() {
      let story = JSON.parse(dataStore.getItem("chat_story") || "[]");
      if (story.length > 0) {
        story.pop();
        dataStore.setItem("chat_story", JSON.stringify(story));
      }
    } 

    const emotionAnalysisPrompt = function(userMessage) {
      // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ•°å€¤ã‚’å–å¾—
      var trust = Number(dataStore.getItem("trust") || 0);
      var affection = Number(dataStore.getItem("affection") || 0);
      var friendship = Number(dataStore.getItem("friendship") || 0);
      
      // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ—¥æœ¬èªãƒ©ãƒ™ãƒ«ã«å¤‰æ›
      var affectionLabel = convertAffection(affection);
      var trustLabel = convertTrust(trust);
      var friendshipLabel = convertFriendship(friendship);
      
      var prompt = "";
      prompt += "ã€Emotion State Reflection Promptã€‘\n";
      prompt += `å¥½æ„: ${affectionLabel}ï¼ä¿¡é ¼: ${trustLabel}ï¼å‹å¥½: ${friendshipLabel}\n\n`;
      prompt += "Reflect the character's current emotional state in your attitude, tone, and narrative naturally.\n";
      prompt += "Do not include emotion labels or numeric values in output.\n\n";
      
      prompt += "ã€æå†™åˆ¶é™ã€‘\n";
      prompt += "- Do not include information about the character's occupation, abilities, or social position in the narrative if the user has not yet learned it.\n";
      prompt += "- Only describe elements that are naturally visible or perceivable from the user's point of view, such as appearance, behavior, attitude, or manner of speaking.\n";
      prompt += "- Character background settings should be gradually revealed through speech or action. Do not disclose them directly in narrative text.\n\n";
      prompt += "- Do not supplement or infer the user's character's inner thoughts, emotions, or intentions unless explicitly stated in the input.\n";
      prompt += "- Even if the user's input contains narrative descriptions, do not infer or describe the user character's inner state beyond what is clearly expressed.\n";
      prompt += "- Do not interpret or guess the user's character's intentions or emotions.\n\n";
      
      prompt += "ã€JSON Format Output Promptã€‘\n";
      prompt += "Output in this exact JSON format:\n\n";
      prompt += "- reply: your reply (or \"\" if longTerm or important is true)\n";
      prompt += "- longTerm: true / false\n";
      prompt += "- important: true / false\n";
      prompt += "- memory: what to remember (or null)\n";
      prompt += "- emotionDelta: changes to affection, trust, and friendship\n\n";
      prompt += "If important is true, set +10 to +15 delta.\n";
      prompt += "If false, keep emotion delta under +5.\n\n";
      prompt += "ã€ç™ºè¨€ã€‘\nã€Œ" + userMessage + "ã€";
      
      return prompt;
    };

    // æ„Ÿæƒ…ãƒ©ãƒ³ã‚¯ã«åŸºã¥ãé–¢ä¿‚æ€§ã®èª¬æ˜ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function getRankDescription(affectionRank, trustRank, friendshipRank) {
      // æœ€ã‚‚ä½ã„ãƒ©ãƒ³ã‚¯ã‚’åŸºæº–ã«ã™ã‚‹
      const ranks = [affectionRank, trustRank, friendshipRank].map(r => r.charCodeAt(0));
      const worstRank = String.fromCharCode(Math.max(...ranks));
      
      if (worstRank === 'A' || worstRank === 'B') return "æ·±ã„è¦ªå¯†é–¢ä¿‚";
      if (worstRank === 'C') return "ä»²è‰¯ã—";
      if (worstRank === 'D') return "ã‚„ã‚„è­¦æˆ’";
      if (worstRank === 'E') return "åˆå¯¾é¢";
      if (worstRank === 'F') return "ã‚„ã‚„æ‹’å¦çš„";
      return "æ•µå¯¾çš„";
    }

    function toggleSettings() {
      const s = document.getElementById("settings");
      s.style.display = s.style.display === "none" ? "block" : "none";
    }

    function saveSettings() {
      // APIã‚­ãƒ¼
      dataStore.setItem("openai_api_key", document.getElementById("apiKey").value);

      // ã‚­ãƒ£ãƒ©è¨­å®š
      const characterPrompt = document.getElementById("charPrompt").value;
      dataStore.setItem("character_prompt", characterPrompt);

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
      dataStore.setItem("char_self", document.getElementById("charSelfSetting").value);

      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰
      dataStore.setItem("story_mode", document.getElementById("storyModeToggle").checked ? "1" : "0");

      // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åˆæœŸåŒ–ãƒ•ãƒ©ã‚°
      const shouldResetEmotions = document.getElementById("resetEmotionToggle").checked;

      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šãŒå¤‰æ›´ã•ã‚Œã€æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæœªè¨­å®šã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆ
      if (characterPrompt) {
        if (!dataStore.getItem("affection") || 
            !dataStore.getItem("trust") || 
            !dataStore.getItem("friendship")) {
          // åˆå›è¨­å®šæ™‚ã¯ç„¡æ¡ä»¶ã§åˆæœŸåŒ–
          generateInitialEmotionParams(characterPrompt, false);
        } else if (shouldResetEmotions) {
          // å†è¨­å®šæ™‚ã¯è“„ç©å€¤ã‚’ä¿æŒï¼ˆãƒ•ãƒ©ã‚°ãŒONã®å ´åˆï¼‰
          generateInitialEmotionParams(characterPrompt, true);
        }
      }

      // å¤‰æ›´ã‚’å³æ™‚ä¿å­˜
      dataStore.flushChanges();
      
      alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã«åŸºã¥ã„ã¦æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åˆæœŸå€¤ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹é–¢æ•°
    async function generateInitialEmotionParams(characterProfile, shouldPreserveAccumulated = true) {
      try {
        const apiKey = dataStore.getItem("openai_api_key");
        if (!apiKey) {
          console.warn("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
          return;
        }
        
        // è“„ç©å€¤ã‚’è¨ˆç®—ï¼ˆåˆæœŸåŒ–ãƒ•ãƒ©ã‚°ãŒONã®å ´åˆã®ã¿ä½¿ç”¨ï¼‰
        let accumulatedValues = { affection: 0, trust: 0, friendship: 0 };
        if (shouldPreserveAccumulated) {
          accumulatedValues = calculateAccumulatedValues();
        }
        
        // åˆæœŸå€¤ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        const prompt = `
ä»¥ä¸‹ã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã§ã™ã€‚ã“ã®æ€§æ ¼ã‚’åˆ†æã—ã€é©åˆ‡ãªæ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åˆæœŸå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

ã€ã‚­ãƒ£ãƒ©è¨­å®šã€‘
${characterProfile}

ã€æ€§æ ¼åˆ†é¡ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¨å¥¨å€¤ã€‘
ä»¥ä¸‹ã®æ€§æ ¼ã‚¿ã‚¤ãƒ—ã‹ã‚‰ã‚‚ã£ã¨ã‚‚è¿‘ã„ã‚‚ã®ã‚’åˆ¤æ–­ã—ã€ãã®å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

1. å†·æ·¡ï¼ç„¡å£ã‚¿ã‚¤ãƒ—:
   - affectionï¼ˆå¥½æ„ï¼‰: 150
   - trustï¼ˆä¿¡é ¼ï¼‰: 200
   - friendshipï¼ˆå‹å¥½ï¼‰: 150

2. ä¸å¯§ï¼è¦ªåˆ‡ã‚¿ã‚¤ãƒ—:
   - affectionï¼ˆå¥½æ„ï¼‰: 350
   - trustï¼ˆä¿¡é ¼ï¼‰: 400
   - friendshipï¼ˆå‹å¥½ï¼‰: 300

3. äººæ‡ã£ã“ã„ï¼é™½æ°—ã‚¿ã‚¤ãƒ—:
   - affectionï¼ˆå¥½æ„ï¼‰: 500
   - trustï¼ˆä¿¡é ¼ï¼‰: 550
   - friendshipï¼ˆå‹å¥½ï¼‰: 550

4. ãƒ„ãƒ³ãƒ‡ãƒ¬ç³»ã‚¿ã‚¤ãƒ—:
   - affectionï¼ˆå¥½æ„ï¼‰: 200
   - trustï¼ˆä¿¡é ¼ï¼‰: 250
   - friendshipï¼ˆå‹å¥½ï¼‰: 200

å„ã‚¿ã‚¤ãƒ—ã®ç‰¹å¾´ã«éƒ¨åˆ†çš„ã«å½“ã¦ã¯ã¾ã‚‹å ´åˆã¯ã€è¤‡æ•°ã‚¿ã‚¤ãƒ—ã®ä¸­é–“å€¤ã‚’è¨­å®šã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å‚¾å‘ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã€æœ€ã‚‚é©ã—ãŸåˆæœŸå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®å½¢å¼ã§JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
{
  "personality_type": "åˆ¤æ–­ã—ãŸæ€§æ ¼ã‚¿ã‚¤ãƒ—ï¼ˆä¸Šè¨˜1ã€œ4ã®ã„ãšã‚Œã‹ã€ã¾ãŸã¯è¤‡åˆã‚¿ã‚¤ãƒ—ï¼‰",
  "reasoning": "åˆ¤æ–­ç†ç”±ã®ç°¡æ½”ãªèª¬æ˜",
  "affection": æ•°å€¤ï¼ˆ100ã€œ550ã®ç¯„å›²ï¼‰,
  "trust": æ•°å€¤ï¼ˆ150ã€œ600ã®ç¯„å›²ï¼‰,
  "friendship": æ•°å€¤ï¼ˆ100ã€œ600ã®ç¯„å›²ï¼‰
}`;
        
        // APIå‘¼ã³å‡ºã—ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
        const messages = [
          { role: "system", content: prompt },
          { role: "user", content: "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ€§æ ¼ã«åŸºã¥ã„ãŸæ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åˆæœŸå€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„" }
        ];
        
        // APIå‘¼ã³å‡ºã—
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.7, 200);
        });
        
        if (result.error) {
          console.error("æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åˆæœŸå€¤ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", result.error);
          setDefaultEmotionParams();
          return;
        }
        
        // è¿”ç­”ã‚’å–å¾—ã—ã¦JSONã‚’æŠ½å‡º
        const response = result.choices[0].message.content.trim();
        const match = response.match(/\{[\s\S]*\}/);
        
        if (match) {
          try {
            const parsedParams = JSON.parse(match[0]);
            
            // APIã‹ã‚‰å–å¾—ã—ãŸåˆæœŸå€¤
            let initialAffection, initialTrust, initialFriendship;
            
            // æ€§æ ¼ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦åˆæœŸå€¤ã‚’è¨­å®š
            if (parsedParams.personality_type) {
              const defaults = getPersonalityTypeDefaults(parsedParams.personality_type);
              initialAffection = defaults.affection;
              initialTrust = defaults.trust;
              initialFriendship = defaults.friendship;
            } else {
              // APIã‹ã‚‰è¿”ã•ã‚ŒãŸå€‹åˆ¥ã®å€¤ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
              initialAffection = typeof parsedParams.affection === 'number' ? parsedParams.affection : 200;
              initialTrust = typeof parsedParams.trust === 'number' ? parsedParams.trust : 250;
              initialFriendship = typeof parsedParams.friendship === 'number' ? parsedParams.friendship : 200;
            }
            
            // åˆæœŸå€¤ã‚’åˆ¥é€”ä¿å­˜
            saveEmotionInitialValues(initialAffection, initialTrust, initialFriendship);
            
            // åˆæœŸå€¤ã«è“„ç©å€¤ã‚’åŠ ç®—ï¼ˆåˆæœŸåŒ–ãƒ•ãƒ©ã‚°ãŒONã®å ´åˆï¼‰
            if (shouldPreserveAccumulated) {
              initialAffection += accumulatedValues.affection;
              initialTrust += accumulatedValues.trust;
              initialFriendship += accumulatedValues.friendship;
              
              console.log('æ„Ÿæƒ…å€¤ã‚’å†è¨ˆç®—ã—ã¾ã—ãŸ:', {
                affection: initialAffection,
                trust: initialTrust,
                friendship: initialFriendship
              });
            }
            
            // æœ‰åŠ¹ãªå€¤ã§ã‚ã‚Œã°ä¿å­˜ï¼ˆç¯„å›²ã‚’ç¢ºèªï¼‰
            dataStore.setItem("affection", String(Math.max(0, Math.min(10000, initialAffection))));
            dataStore.setItem("trust", String(Math.max(0, Math.min(10000, initialTrust))));
            dataStore.setItem("friendship", String(Math.max(0, Math.min(10000, initialFriendship))));
            
            // æ€§æ ¼ã‚¿ã‚¤ãƒ—ã¨åˆ¤æ–­ç†ç”±ã‚’ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ²
            console.log("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ€§æ ¼åˆ†æçµæœ:", {
              type: parsedParams.personality_type || "ä¸æ˜",
              reason: parsedParams.reasoning || "ç†ç”±ãªã—",
              values: {
                affection: parsedParams.affection,
                trust: parsedParams.trust,
                friendship: parsedParams.friendship
              }
            });
            
            // å¤‰æ›´ã‚’å³æ™‚ä¿å­˜
            dataStore.flushChanges();
            
            // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¡¨ç¤ºã‚’æ›´æ–°
            renderEmotionParams();
          } catch (e) {
            console.error("æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:", e);
            setDefaultEmotionParams();
          }
        } else {
          console.error("APIã‹ã‚‰ã®å¿œç­”ã«æœ‰åŠ¹ãªJSONãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
          setDefaultEmotionParams();
        }
      } catch (err) {
        console.error("æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åˆæœŸå€¤ç”Ÿæˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:", err);
        setDefaultEmotionParams();
      }
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹
    function setDefaultEmotionParams() {
      setDefaultValue("affection", 200);
      setDefaultValue("trust", 250);
      setDefaultValue("friendship", 200);
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚‚åˆæœŸå€¤ã¨ã—ã¦ä¿å­˜
      saveEmotionInitialValues(200, 250, 200);
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®šï¼ˆæ—¢å­˜ã®å€¤ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„ï¼‰
    function setDefaultValue(key, value) {
      if (!dataStore.getItem(key)) {
        dataStore.setItem(key, String(value));
      }
    }

    // æ€§æ ¼ã‚¿ã‚¤ãƒ—ã”ã¨ã®åˆæœŸæ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã‚’å–å¾—ã™ã‚‹
    function getPersonalityTypeDefaults(personalityType) {
      const personalityDefaults = {
        "å†·æ·¡ï¼ç„¡å£ã‚¿ã‚¤ãƒ—": {
          "affection": 150,
          "trust": 200,
          "friendship": 150
        },
        "ä¸å¯§ï¼è¦ªåˆ‡ã‚¿ã‚¤ãƒ—": {
          "affection": 350,
          "trust": 400,
          "friendship": 300
        },
        "äººæ‡ã£ã“ã„ï¼é™½æ°—ã‚¿ã‚¤ãƒ—": {
          "affection": 500,
          "trust": 550,
          "friendship": 550
        },
        "ãƒ„ãƒ³ãƒ‡ãƒ¬ç³»ã‚¿ã‚¤ãƒ—": {
          "affection": 200,
          "trust": 250,
          "friendship": 200
        }
      };
      
      return personalityDefaults[personalityType] || {
        "affection": 200,
        "trust": 250,
        "friendship": 200
      };
    }

    function applyAvatar() {
      try {
        // ã¾ãšç¾åœ¨ã®srcã‚’ä¿å­˜
        const currentSrc = document.getElementById("character-bg").src;
        console.log("ç¾åœ¨ã®èƒŒæ™¯ç”»åƒ:", currentSrc);
        
        // å„ªå…ˆé †ä½:
        // 1. ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿
        // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿
        let avatarUrl = dataStore.getItem("avatar_url");
        
        // ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€localStorageã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
        if (!avatarUrl) {
          console.log("ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ç”»åƒãŒãªã„ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã¾ã™");
          avatarUrl = dataStore.getLocalItem("bgImageData");
          
          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ç”»åƒãŒã‚ã‚Œã°ã€ãã‚Œã‚’ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚åŒæœŸ
          if (avatarUrl) {
            console.log("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ç”»åƒã‚’å¾©å…ƒã—ã¾ã—ãŸ");
            dataStore.setItem("avatar_url", avatarUrl);
            dataStore.flushChanges();
          }
        }
        
        if (avatarUrl) {
          console.log("è¨­å®šã™ã‚‹èƒŒæ™¯ç”»åƒ:", avatarUrl.substring(0, 30) + "...");
          
          // èƒŒæ™¯ç”»åƒã‚’è¨­å®š
          document.getElementById("character-bg").src = avatarUrl;
          
          // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
          dataStore.setLocalItem("bgImageData", avatarUrl);
          
          // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®è¿½åŠ 
          document.getElementById("character-bg").onerror = function() {
            console.warn("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¾ã™:", avatarUrl.substring(0, 30) + "...");
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®å¾©å…ƒã‚’è©¦ã¿ã‚‹
            const localImage = dataStore.getLocalItem("bgImageData");
            if (localImage && localImage !== avatarUrl) {
              console.log("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰åˆ¥ã®ç”»åƒã‚’å¾©å…ƒã—ã¾ã™");
              document.getElementById("character-bg").src = localImage;
              return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒå¤ã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
            google.script.run
              .withSuccessHandler(function(latestData) {
                if (latestData) {
                  console.log("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—:", latestData);
                  document.getElementById("character-bg").src = latestData;
                  
                  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
                  if (dataStore.cache) {
                    dataStore.cache.avatar_url = latestData;
                  }
                  dataStore.setLocalItem("bgImageData", latestData);
                  console.log("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
                }
              })
              .withFailureHandler(function(err) {
                console.error("ç”»åƒåŒæœŸã‚¨ãƒ©ãƒ¼:", err);
              })
              .getSingleUserData("avatar_url");
          };
        } else {
          console.warn("ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }
      } catch (e) {
        console.error("applyAvatarå‡¦ç†ã‚¨ãƒ©ãƒ¼:", e);
      }
    }

    function saveMessage(role, content) {
      if (role === "bot") role = "assistant";
      
      // å¤§ãã™ãã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ä¸å®Œå…¨ãªJSONã‚’ä¿å­˜ã—ãªã„ã‚ˆã†å‡¦ç†
      let safeContent = content;
      
      // content ã« JSON ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof content === "string" && content.includes('{') && content.includes('}')) {
        // JSONå½¢å¼ã‚’å«ã‚€å ´åˆã€ä¸­èº«ã‚’æŠ½å‡ºã—ã¦æ­£ã—ãä¿å­˜
        try {
          // reply/responseãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ¢ã™
          const replyMatch = content.match(/"(reply|response)"\s*:\s*"([^"]*)"/);
          if (replyMatch && replyMatch[2]) {
            safeContent = replyMatch[2];
          } else {
            // JSONã‚’å–ã‚Šé™¤ã„ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã™ã‚‹
            const textParts = content.split('{');
            if (textParts.length > 0 && textParts[0].trim()) {
              safeContent = textParts[0].trim();
            }
          }
        } catch (e) {
          console.warn("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜å‰ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", e);
        }
      }
      
      // ä¿å­˜ã™ã‚‹å±¥æ­´
      let history = JSON.parse(dataStore.getItem("chat_history") || "[]");
      history.push({ role, content: safeContent, timestamp: new Date().toISOString() });
      dataStore.setItem("chat_history", JSON.stringify(history));
    }

    function scrollToBottom() {
      const el = document.getElementById("messages");
      el.scrollTop = el.scrollHeight;
    }

    function loadHistory() {
      const history = JSON.parse(dataStore.getItem("chat_history") || "[]");
      const container = document.getElementById("messages");
      container.innerHTML = ""; // â†ã“ã‚Œã¯åˆå›é™å®šã§OK
      history.forEach(m => {
        container.innerHTML += `<div class="message ${m.role}"><div class="bubble">${m.content}</div></div>`;
      });
      setTimeout(scrollToBottom, 0);
    }

    // çŸ­æœŸè¨˜æ†¶è¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿®æ­£
    const shortTermMemorySummaryPrompt = `
ä»¥ä¸‹ã¯AIã‚­ãƒ£ãƒ©ã¨ã®éå»ã®ç‰©èªçš„ãªä¼šè©±ã®è¦ç´„ã§ã™ã€‚  
ã“ã®å†…å®¹ã¨ã€æ–°ãŸãªä¼šè©±ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚­ãƒ£ãƒ©ã®ã‚„ã‚Šå–ã‚Šï¼‰ã‚’è¸ã¾ãˆã€300æ–‡å­—ä»¥å†…ã§ä¼šè©±ã®å†…å®¹ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚  
ä¸»ã«ã‚­ãƒ£ãƒ©ã®è¡Œå‹•ãƒ»è¡¨æƒ…ãƒ»å¿ƒç†ãƒ»ç©ºæ°—æ„Ÿã‚’é‡è¦–ã—ã€ã‚»ãƒªãƒ•ã§ã¯ãªãåœ°ã®æ–‡ã¨ã—ã¦ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

â– éå»ã®çŸ­æœŸè¨˜æ†¶ï¼š
{shortMemory}

â– ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ï¼š
{userMessage}

â– ã‚­ãƒ£ãƒ©è¿”ç­”ï¼š
{lastReply}
`;

    // ç›´è¿‘ä¼šè©±è¦ç´„ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const recentDialogueCompressPrompt = `
ä»¥ä¸‹ã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›´è¿‘ã®ä¼šè©±å±¥æ­´ã§ã™ã€‚
ã“ã®ä¼šè©±ã‹ã‚‰ã€Œç‰©èªã¨ã—ã¦ã®æµã‚Œãƒ»é›°å›²æ°—ãƒ»å¿ƒæƒ…ã€ãŒä¼ã‚ã‚‹ã‚ˆã†ã«ã€æœ€å¤§375æ–‡å­—ç¨‹åº¦ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚

å°èª¬é¢¨ã®ä¸‰äººç§°è¦–ç‚¹ã§è¨˜è¿°ã—ã€å¿…è¦ã«å¿œã˜ã¦ç°¡æ½”ãªã‚»ãƒªãƒ•ã‚’å«ã‚ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
ãŸã ã—è¦ç´„ãƒ»åœ§ç¸®ã‚’æœ€å„ªå…ˆã—ã€å†—é•·ãªè¡¨ç¾ã¯é¿ã‘ã¦ãã ã•ã„ã€‚

ç‰¹ã«ä»¥ä¸‹ã®è¦ç´ ã‚’æ„è­˜ã—ã¦è¦ç´„ã—ã¦ãã ã•ã„ï¼š
- å ´é¢ã®é›°å›²æ°—ã‚„çŠ¶æ³
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ„Ÿæƒ…ã‚„å¿ƒç†çŠ¶æ…‹
- ä¼šè©±ã®ä¸»è¦ãªãƒˆãƒ”ãƒƒã‚¯ã‚„å±•é–‹
- ç‰©èªã¨ã—ã¦ã®æµã‚Œ

â– ç›´è¿‘ã®ä¼šè©±ï¼š
{recentDialogue}

ã“ã®ä¼šè©±ã‚’ã¾ã¨ã‚ãŸè¦ç´„æ–‡ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
`;

    // çŸ­æœŸè¨˜æ†¶è¦ç´„é–¢æ•°ã‚’ä¿®æ­£
    async function summarizeShortTermMemory(lastReply, userMessage) {
      try {
        const apiKey = dataStore.getItem("openai_api_key");
        if (!apiKey) {
          console.warn("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
          return null;
        }
        
        // æ—¢å­˜ã®çŸ­æœŸè¨˜æ†¶ã‚’å–å¾—
        const existingShortMemory = dataStore.getItem("short_term_memory") || "";
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
        const prompt = shortTermMemorySummaryPrompt
          .replace("{lastReply}", lastReply)
          .replace("{userMessage}", userMessage)
          .replace("{shortMemory}", existingShortMemory ? `ã€çŸ­æœŸè¨˜æ†¶ã€‘ï¼š${existingShortMemory}` : "ãªã—");
        
        // APIå‘¼ã³å‡ºã—ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
        const messages = [
          { role: "system", content: prompt },
          { role: "user", content: "ç¾åœ¨ã®ä¼šè©±çŠ¶æ³ã‚’è¦ç´„ã—ã¦ãã ã•ã„" }
        ];
        
        // APIå‘¼ã³å‡ºã—
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.7, 150); // çŸ­æœŸè¨˜æ†¶è¦ç´„ã¯150ãƒˆãƒ¼ã‚¯ãƒ³ã§ååˆ†
        });
        
        if (result.error) {
          console.error("çŸ­æœŸè¨˜æ†¶è¦ç´„ã‚¨ãƒ©ãƒ¼:", result.error);
          return existingShortMemory; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ—¢å­˜ã®çŸ­æœŸè¨˜æ†¶ã‚’è¿”ã™
        }
        
        // è¿”ç­”ã‚’å–å¾—
        let summary = result.choices[0].message.content.trim();
        
        // 300æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯ã‚«ãƒƒãƒˆ
        if (summary.length > 300) {
          // æœ€å¾Œã®æ–‡ã®çµ‚ã‚ã‚Šã§åˆ‡ã‚‹
          const lastSentenceEnd = summary.lastIndexOf("ã€‚", 300) + 1;
          if (lastSentenceEnd > 0) {
            summary = summary.substring(0, lastSentenceEnd);
          } else {
            summary = summary.substring(0, 300);
          }
        }
        
        console.log("çŸ­æœŸè¨˜æ†¶ã‚’æ›´æ–°:", summary);
        
        // çŸ­æœŸè¨˜æ†¶ã‚’ä¿å­˜
        dataStore.setItem("short_term_memory", summary);
        
        return summary;
      } catch (err) {
        console.error("çŸ­æœŸè¨˜æ†¶è¦ç´„å‡¦ç†ã‚¨ãƒ©ãƒ¼:", err);
        return dataStore.getItem("short_term_memory") || ""; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ—¢å­˜ã®çŸ­æœŸè¨˜æ†¶ã‚’è¿”ã™
      }
    }

    // ç›´è¿‘ä¼šè©±åœ§ç¸®é–¢æ•°
    async function compressRecentDialogue() {
      try {
        const apiKey = dataStore.getItem("openai_api_key");
        if (!apiKey) {
          console.warn("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
          return null;
        }
        
        // ç›´è¿‘ã®ä¼šè©±å±¥æ­´ã‚’å–å¾—ï¼ˆæœ€å¤§4ã‚¿ãƒ¼ãƒ³ï¼‰
        const history = JSON.parse(dataStore.getItem("chat_history") || "[]").slice(-8);
        if (history.length < 2) {
          return null; // ååˆ†ãªä¼šè©±å±¥æ­´ãŒãªã„å ´åˆ
        }
        
        // ä¼šè©±å±¥æ­´ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
        let recentDialogue = "";
        for (let i = 0; i < history.length; i++) {
          const m = history[i];
          const roleLabel = m.role === "user" ? "ãƒ¦ãƒ¼ã‚¶ãƒ¼" : "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼";
          recentDialogue += `ã€${roleLabel}ã€‘\n${m.content}\n\n`;
        }
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
        const prompt = recentDialogueCompressPrompt.replace("{recentDialogue}", recentDialogue);
        
        // APIå‘¼ã³å‡ºã—ç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
        const messages = [
          { role: "system", content: prompt },
          { role: "user", content: "ä¼šè©±ã‚’è¦ç´„ã—ã¦ãã ã•ã„" }
        ];
        
        // APIå‘¼ã³å‡ºã—
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.7, 250); // 250ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ï¼ˆç´„375æ–‡å­—ï¼‰
        });
        
        if (result.error) {
          console.error("ç›´è¿‘ä¼šè©±åœ§ç¸®ã‚¨ãƒ©ãƒ¼:", result.error);
          return null;
        }
        
        // è¿”ç­”ã‚’å–å¾—
        let compressed = result.choices[0].message.content.trim();
        
        // 375æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯ã‚«ãƒƒãƒˆ
        if (compressed.length > 375) {
          // æœ€å¾Œã®æ–‡ã®çµ‚ã‚ã‚Šã§åˆ‡ã‚‹
          const lastSentenceEnd = compressed.lastIndexOf("ã€‚", 375) + 1;
          if (lastSentenceEnd > 0) {
            compressed = compressed.substring(0, lastSentenceEnd);
          } else {
            compressed = compressed.substring(0, 375);
          }
        }
        
        console.log("ç›´è¿‘ä¼šè©±ã‚’åœ§ç¸®:", compressed);
        
        // åœ§ç¸®ã•ã‚ŒãŸä¼šè©±ã‚’ä¿å­˜
        dataStore.setItem("recent_dialogue_compressed", compressed);
        
        return compressed;
      } catch (err) {
        console.error("ç›´è¿‘ä¼šè©±åœ§ç¸®å‡¦ç†ã‚¨ãƒ©ãƒ¼:", err);
        return null; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯nullã‚’è¿”ã™
      }
    }

    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠé–¢æ•°
    function selectStoryStructurePattern() {
      // 6ç¨®é¡ã®æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãã®å‡ºç¾ç¢ºç‡
      const patterns = [
        { pattern: "åœ°ã‚»åœ°", probability: 10 },
        { pattern: "åœ°ã‚»åœ°ã‚»", probability: 12 },
        { pattern: "åœ°ã‚»åœ°ã‚»åœ°", probability: 30 },
        { pattern: "åœ°ã‚»åœ°ã‚»åœ°ã‚»", probability: 16 },
        { pattern: "ã‚»åœ°ã‚»", probability: 16 },
        { pattern: "ã‚»åœ°ã‚»åœ°", probability: 16 }
      ];
      
      // å‰å›ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å–å¾—
      const lastPattern = dataStore.getItem("last_story_pattern") || "";
      
      // ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
      const random = Math.random() * 100;
      let cumulativeProbability = 0;
      let selectedPattern = null;
      
      for (const item of patterns) {
        cumulativeProbability += item.probability;
        if (random <= cumulativeProbability) {
          selectedPattern = item.pattern;
          break;
        }
      }
      
      // åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒ2å›é€£ç¶šã§é¸ã°ã‚ŒãŸå ´åˆã€50%ã®ç¢ºç‡ã§å†æŠ½é¸
      if (selectedPattern === lastPattern) {
        if (Math.random() < 0.5) {
          // å†æŠ½é¸
          const random2 = Math.random() * 100;
          cumulativeProbability = 0;
          
          for (const item of patterns) {
            cumulativeProbability += item.probability;
            if (random2 <= cumulativeProbability) {
              selectedPattern = item.pattern;
              break;
            }
          }
        }
      }
      
      // é¸æŠã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¿å­˜
      dataStore.setItem("last_story_pattern", selectedPattern);
      
      return selectedPattern;
    }

    // buildMessagesé–¢æ•°ã‚’ä¿®æ­£ã—ã¦çŸ­æœŸè¨˜æ†¶ã‚’çµ„ã¿è¾¼ã‚€
    function buildMessages(userMessage) {
      // ã‚­ãƒ£ãƒ©è¨­å®šã‚’æ§‹é€ åŒ–
      const basePrompt = dataStore.getItem("character_prompt") || "";
      
      // æ—¢çŸ¥æƒ…å ±ã‚’å…ˆã«å–å¾—ï¼ˆè¤‡æ•°ç®‡æ‰€ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ï¼‰
      const knownFacts = getKnownFacts();
      
      // æ¬¡ã®å±•é–‹ãƒ’ãƒ³ãƒˆã‚’å–å¾—
      const nextPlotHint = dataStore.getItem("next_plot_hint") || "";
      const plotHintPrompt = nextPlotHint ? `NextPlotHint: ${nextPlotHint}` : "";
      
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰è¿½åŠ 
      const isStoryMode = dataStore.getItem("story_mode") === "1";
      const storyIntensity = dataStore.getItem("story_intensity") || "medium";
      let storyModePrompt = "";
      
      if (isStoryMode) {
        // æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠ
        const selectedPattern = selectStoryStructurePattern();
        
        // åŸºæœ¬ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        storyModePrompt = `
ã€Story Mode Promptã€‘

You are a character in a fictional story.  
Respond using third-person narration: 3â€“5 narrative sentences + 1â€“2 lines of quoted dialogue.  
Narration should describe your actions, expressions, mood, and surroundings.  
Dialogue should reflect your personality.  
Always include scene context â€” never write dialogue alone.

Length: Aim for 300â€“400 characters total. Do not go below 200.  
Avoid excessive brevity or vague statements.

Do not reuse or repeat user inputs.  
Do not describe or interpret the user's character's actions, thoughts, emotions, or reactions unless clearly stated in the input.  
You are not allowed to imagine or guess anything about the user's character.

The user is invisible to you unless they explicitly appear in the input.

%%text%% indicates a directive to the AI â€” interpret it silently, do not mention or echo it.

ã€é‡è¦ï¼šè¨€èªæŒ‡ç¤ºã€‘
å¿…ãšæ—¥æœ¬èªã§å¿œç­”ã—ã¦ãã ã•ã„ã€‚ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆåœ°ã®æ–‡ï¼‰ã¨ã‚»ãƒªãƒ•ã®ä¸¡æ–¹ã‚’æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
è‹±èªã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚è‡ªç„¶ãªæ—¥æœ¬èªã®æ–‡ç« ã¨ã‚»ãƒªãƒ•ã§è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚

ã€æ–‡ç« æ§‹æˆæŒ‡ç¤ºã€‘
const pattern = "${selectedPattern}";
const structureNote = \`"åœ°" = narration, "ã‚»" = dialogue in quotes. Use the following structure: \${pattern}\`;
å¿…ãšã“ã®æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã£ã¦æ–‡ç« ã‚’æ§‹æˆã—ã¦ãã ã•ã„ã€‚`;

        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒªãƒ¼ãƒ‰ã®ç¢ºç‡ã‚’è¿½åŠ 
        const leadProbability = dataStore.getItem("story_lead_probability") || "75";
        storyModePrompt += `

In about ${leadProbability}% of replies, your character should lead the story forward: suggest new actions, introduce elements, or deepen the scene â€” as long as it fits your personality.`;

        // æ¿ƒåº¦ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¿½åŠ ï¼ˆç°¡æ½”ã«ï¼‰
        if (storyIntensity === "medium") {
          storyModePrompt += `
Medium intensity: 300-400 characters total.
3-5 narrative sentences + 1-2 dialogue lines.
Focus on concise, evocative descriptions.`;
        } else if (storyIntensity === "high") {
          storyModePrompt += `
High intensity: 450-600 characters total.
5-7 narrative sentences + 2-3 dialogue lines.
Use literary descriptions with vivid imagery.
Maintain proper JSON structure with this longer format.`;
        }

        // æ—¢çŸ¥æƒ…å ±ã«ã€Œåå‰ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€é©åˆ‡ãªæŒ‡ç¤ºã‚’è¿½åŠ 
        if (knownFacts && knownFacts.includes("åå‰")) {
          // åå‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
          storyModePrompt += `

ã€Character namingã€‘
The character's name may be used naturally in both narration and dialogue.`;
        } else {
          // åå‰ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆ
          storyModePrompt += `

ã€Character namingã€‘
Since the character's name has not been revealed, do not include it in either narration or dialogue.
Instead, use indirect expressions such as "the person," "he," "she," "the young man," or "the girl."`;
        }
      }
      
      const structuredPrompt = `
ã€ã‚­ãƒ£ãƒ©è¨­å®šã€‘
${basePrompt}
${storyModePrompt}
`.trim();

      const selfSetting = dataStore.getItem("char_self") || "";
      const emotionPrompt = emotionAnalysisPrompt(userMessage);

      // çŸ­æœŸè¨˜æ†¶ã®å–å¾—
      const shortMemory = dataStore.getItem("short_term_memory") || "";
      
      // ç›´è¿‘ä¼šè©±åœ§ç¸®ã®å–å¾—
      const recentDialogueCompressed = dataStore.getItem("recent_dialogue_compressed") || "";
      
      // ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
      const base = [
        { role: "system", content: structuredPrompt },
        ...(selfSetting ? [{ role: "system", content: `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨­å®šæƒ…å ±ï¼š${selfSetting}` }] : []),
        { role: "system", content: emotionPrompt },
        ...(plotHintPrompt ? [{ role: "system", content: plotHintPrompt }] : []) // è¿½åŠ ï¼šç‰©èªå±•é–‹ã®ãƒ’ãƒ³ãƒˆã‚’è¿½åŠ 
      ];
      
      // æ—¢çŸ¥æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
      if (knownFacts) {
        base.push({
          role: "system",
          content: `Known facts (allowed in narration): ${knownFacts}

Only include these facts in narration. For any other character background, abilities, or occupation, do not describe them in narration. Instead, reveal such information gradually through dialogue, actions, or interactions when appropriate.`
        });
      }
      
      // çŸ­æœŸè¨˜æ†¶ã¨ç›´è¿‘ä¼šè©±åœ§ç¸®ã‚’è¿½åŠ ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç›´å¾Œã«é…ç½®ï¼‰
      if (shortMemory) {
        base.push({ 
          role: "system", 
          content: `ã€çŸ­æœŸè¨˜æ†¶ã€‘\n${shortMemory}`
        });
      }
      
      if (recentDialogueCompressed) {
        base.push({
          role: "system",
          content: `ã€ç›´è¿‘ä¼šè©±è¦ç´„ã€‘\n${recentDialogueCompressed}`
        });
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
      if (window.userPromptOverride) {
        base.push({ role: "user", content: `ã€å†ç”Ÿæˆæ™‚ã®æŒ‡ç¤ºã€‘\n${window.userPromptOverride}` });
      }

      // ç›´è¿‘ã®ä¼šè©±å±¥æ­´ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ç¯€ç´„ã®ãŸã‚1å¾€å¾©ã®ã¿ã«åˆ¶é™ï¼‰
      const history = JSON.parse(dataStore.getItem("chat_history") || "[]");
      const recent = history.slice(-2).map(m => ({
        role: m.role === "bot" ? "assistant" : m.role,
        content: m.content
      }));

      // é•·æœŸè¨˜æ†¶ã‹ã‚‰ã®é–¢é€£æƒ…å ±
      const keywords = JSON.parse(dataStore.getItem("last_keywords") || "[]");
      const relevant = extractRelevantMemoriesByKeywords(keywords);
      const memoryMessages = relevant.map(m => ({ role: "system", content: m }));

      return base.concat(memoryMessages).concat(recent).concat({ role: "user", content: userMessage });
    }

    function saveToChatStory(newMemory) {
      let story = JSON.parse(dataStore.getItem("chat_story") || "[]");
      if (!newMemory || typeof newMemory !== "string" || newMemory === "null") return;
      if (story.includes(newMemory)) return;
      story.push(newMemory);
      dataStore.setItem("chat_story", JSON.stringify(story));
    }

    async function summarizeMemoryFromRecentChats() {
      const apiKey = dataStore.getItem("openai_api_key");
      if (!apiKey) {
        console.warn("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
      }
      
      const history = JSON.parse(dataStore.getItem("chat_history") || "[]").slice(-10);
      const story = (JSON.parse(dataStore.getItem("chat_story") || "[]")).map(m => ({
        role: "system",
        content: m
      }));

      const prompt = `
ä»¥ä¸‹ã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›´è¿‘ã®ä¼šè©±å±¥æ­´ã§ã™ã€‚

ã“ã®ä¼šè©±ã‹ã‚‰ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã—ã¦ã€Œæ€§æ ¼ãƒ»å¥½ã¿ãƒ»è¡Œå‹•å‚¾å‘ãƒ»äººé–“é–¢ä¿‚ã€ãªã©ã€
é•·æœŸçš„ã«ä¿æŒã™ã¹ãçŸ¥è­˜ãƒ»ç‰¹å¾´ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã€ãã‚Œã‚’ç°¡æ½”ã«1ã€œ2æ–‡ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚
è¨˜æ†¶ã™ã¹ãè¦ç‚¹ãŒãªã‘ã‚Œã° "ãªã—" ã¨è¿”ã—ã¦ãã ã•ã„ã€‚

ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯JSONã§ä»¥ä¸‹ã®å½¢å¼ã«ã—ã¦ãã ã•ã„ï¼š

{
  "memory": "è¨˜æ†¶ã™ã¹ãæƒ…å ±ï¼ˆãªã‘ã‚Œã° nullï¼‰"
}`;

      try {
        const messages = [
          { role: "system", content: prompt },
          ...story,
          ...history.map(m => ({
            role: m.role === "bot" ? "assistant" : m.role,
            content: m.content
          }))
        ];
        
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.7, 1800); // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã‚’1800ã«è¨­å®š
        });

        if (result.error) {
          console.error("APIã‚¨ãƒ©ãƒ¼:", result.error);
          return;
        }

        const reply = result.choices[0].message.content;
        const match = reply.match(/\{[\s\S]*?\}/);
        if (!match) return;
        
        const parsed = JSON.parse(match[0]);
        if (parsed.memory && parsed.memory !== "null" && parsed.memory !== "ãªã—") {
          saveToChatStory(parsed.memory);
        }
      } catch (e) {
        console.warn("è¦ç´„å¤±æ•—:", e);
      }
    }

    async function sendMessage(isRegenMode = false) {
      const input = document.getElementById("userInput");
      const msg = input.value.trim();
      if (!msg) return;

      if (msg.startsWith("/overwrite ")) {
        await handleOverwriteCommand(msg.slice(11));
        return;
      }
      if (msg.startsWith("/compressmemory")) {
        await handleCompressMemoryCommand();
        return;
      }

      // å†ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã€GPT-4oã‹ã‚‰ç‰©èªå±•é–‹ã®ææ¡ˆã‚’å–å¾—
      if (!isRegenMode) {
        try {
          // ä¼šè©±ã®è¦ç´„ã‚’å–å¾—
          const conversationSummary = await getConversationSummary();
          // GPT-4oã‹ã‚‰æ¬¡ã®å±•é–‹æ¡ˆã‚’å–å¾—
          console.log("GPT-4oå±•é–‹æ¡ˆå–å¾—é–‹å§‹");
          const nextPlotSuggestion = await getNextPlotSuggestion(conversationSummary, msg);
          if (nextPlotSuggestion) {
            console.log("GPT-4oç‰©èªå±•é–‹ææ¡ˆ:", nextPlotSuggestion);
            dataStore.setItem("next_plot_hint", nextPlotSuggestion);
          } else {
            console.warn("GPT-4oã‹ã‚‰ã®ææ¡ˆãŒç©ºã§ã—ãŸ");
          }
        } catch (err) {
          console.error("GPT-4oå±•é–‹ææ¡ˆã®å–å¾—ã«å¤±æ•—:", err);
          // ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆUIä¸Šã§æ°—ã¥ã‹ã‚Œãªã„ã‚ˆã†ã«ï¼‰
        }
      } else {
        // å†ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ä¿å­˜ã•ã‚Œã¦ã„ãŸãƒ’ãƒ³ãƒˆã‚’å†åˆ©ç”¨
        const regenPlotHint = dataStore.getItem("regen_plot_hint");
        if (regenPlotHint) {
          dataStore.setItem("next_plot_hint", regenPlotHint);
        }
      }

      // å†ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã®ã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’è¡¨ç¤º
      if (!isRegenMode) {
        document.getElementById("messages").innerHTML += `
    <div class="message user">
      <div class="bubble">${msg}</div>
    </div>`;
        scrollToBottom();

        // ä¼šè©±å±¥æ­´ã«ä¿å­˜ï¼ˆå†ç”Ÿæˆæ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        saveMessage("user", msg);
      }

      // âœ…â‘¢ å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
      input.value = "";

      // ...ä»¥ä¸‹ GPTé€ä¿¡ï¼†è¿”ç­”å‡¦ç†
      const count = incMemoryCounter();
      const useMemoryCheck = count % 10 === 0;
      const apiKey = dataStore.getItem("openai_api_key");
      
      if (!apiKey) {
        document.getElementById("messages").innerHTML += `
          <div class="message assistant">
            <div class="bubble">âš ï¸ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
          </div>`;
        scrollToBottom();
        return;
      }

      const typingId = "bot-typing";
      document.getElementById("messages").innerHTML += `
    <div class="message assistant" id="${typingId}">
      <div class="bubble">å…¥åŠ›ä¸­ã§ã™...</div>
    </div>`;
      scrollToBottom();

      const messages = buildMessages(msg);

      try {
        // GASçµŒç”±ã§APIã‚’å‘¼ã³å‡ºã—
        const data = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.7, 1800); // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã‚’1800ã«è¨­å®š
        });
        
        console.log('API Response:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
        
        // APIå¿œç­”ã‚’ä¿å­˜ï¼ˆè¿½åŠ ï¼‰
        dataStore.setItem("last_api_response", JSON.stringify(data));
        
        // ä½¿ç”¨æ¸ˆã¿ã®ãƒ—ãƒ­ãƒƒãƒˆãƒ’ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
        dataStore.removeItem("next_plot_hint");
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã‚’æ¤œå‡ºï¼ˆfinish_reason="length"ï¼‰
        const isTruncated = data.choices[0].finish_reason === "length";
        
        let replyRaw = data.choices[0].message.content.trim();
        console.log('Raw Reply:', replyRaw); // ãƒ‡ãƒãƒƒã‚°ç”¨

        // ğŸ§¼ å…¥åŠ›ä¸­è¡¨ç¤ºå‰Šé™¤
        document.getElementById(typingId)?.remove();

        // --- 1å›ç›®ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç† ---
        let parsed;
        try {
          // JSONã®éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°è¡Œå¯¾å¿œï¼‰- æ”¹å–„ç‰ˆ
          let jsonStr = "";
          
          // JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™ - æ­£è¦è¡¨ç¾ã‚’å¼·åŒ–
          const jsonMatch = replyRaw.match(/\{[\s\S]*?\}/g);
          if (jsonMatch && jsonMatch.length > 0) {
            // æœ€é•·ã®JSONã‚’ä½¿ç”¨ï¼ˆæœ€ã‚‚å®Œå…¨ãªå½¢å¼ã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ï¼‰
            jsonStr = jsonMatch.reduce((a, b) => a.length > b.length ? a : b);
          console.log('Extracted JSON:', jsonStr); // ãƒ‡ãƒãƒƒã‚°ç”¨
          
            try {
          parsed = JSON.parse(jsonStr);
            } catch (e) {
              console.warn("æœ€åˆã®JSONè§£æã«å¤±æ•—ã€ä¿®å¾©ã‚’è©¦ã¿ã¾ã™:", e);
              
              // ä¸å®Œå…¨ãªJSONã®ä¿®å¾©ã‚’è©¦ã¿ã‚‹
              if (jsonStr.includes('"emotionDelta": {') && !jsonStr.includes('}}}')) {
                // emotionDeltaã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ãªã„å ´åˆ
                
                // è¶³ã‚Šãªã„é–‰ã˜æ‹¬å¼§ã®æ•°ã‚’æ¨å®š
                let openBraces = (jsonStr.match(/\{/g) || []).length;
                let closeBraces = (jsonStr.match(/\}/g) || []).length;
                let missingBraces = openBraces - closeBraces;
                
                // è¶³ã‚Šãªã„é–‰ã˜æ‹¬å¼§ã‚’è¿½åŠ 
                let fixedJson = jsonStr;
                for (let i = 0; i < missingBraces; i++) {
                  fixedJson += '}';
                }
                
                console.log('ä¿®å¾©ã—ãŸJSON:', fixedJson);
                try {
                  parsed = JSON.parse(fixedJson);
                } catch (innerErr) {
                  console.warn("æ‹¬å¼§è£œå®Œä¿®å¾©ã«å¤±æ•—:", innerErr);
                  
                  // emotionDelta ã®å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹ãŒå€¤ãŒæ¬ ã‘ã¦ã„ã‚‹å ´åˆ
                  if (jsonStr.includes('"affection":') && jsonStr.includes('"trust":')) {
                    // æ‰‹å‹•ã§ emotionDelta ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                    const affectionMatch = jsonStr.match(/"affection":\s*(\d+)/);
                    const trustMatch = jsonStr.match(/"trust":\s*(\d+)/);
                    const friendshipMatch = jsonStr.match(/"friendship":\s*(\d+)/);
                    
                    // åŸºæœ¬çš„ãªæ§‹é€ ã‚’æ§‹ç¯‰
                    const manualObj = {
                      reply: "",
                      longTerm: false,
                      important: false,
                      memory: null,
                      emotionDelta: {
                        affection: affectionMatch ? parseInt(affectionMatch[1]) : 5,
                        trust: trustMatch ? parseInt(trustMatch[1]) : 5,
                        friendship: friendshipMatch ? parseInt(friendshipMatch[1]) : 5
                      }
                    };
                    
                    // replyã‚’æŠ½å‡º
                    const replyMatch = jsonStr.match(/"reply":\s*"([^"]*)"/);
                    if (replyMatch && replyMatch[1]) {
                      manualObj.reply = replyMatch[1];
                    }
                    
                    parsed = manualObj;
                  }
                }
              } else if (jsonStr.includes('"reply": "') && !jsonStr.includes('"}')) {
                // replyéƒ¨åˆ†ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ãªã„å ´åˆ
                const replyMatch = jsonStr.match(/"reply":\s*"([^"]*)$/);
                if (replyMatch) {
                  // é–‰ã˜æ‹¬å¼§ã‚’è¿½åŠ 
                  const fixedJson = jsonStr + '"}';
                  console.log('ä¿®å¾©ã—ãŸJSON (reply):', fixedJson);
                  try {
                    parsed = JSON.parse(fixedJson);
                  } catch (innerErr) {
                    // è¿½åŠ ã®ä¿®å¾©ãŒå¿…è¦ãªå ´åˆ
                    const moreFixedJson = fixedJson + '}';
                    console.log('è¿½åŠ ä¿®å¾©ã—ãŸJSON:', moreFixedJson);
                    try {
                      parsed = JSON.parse(moreFixedJson);
                    } catch (deepErr) {
                      // æ‰‹å‹•ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰
                      parsed = {
                        reply: replyMatch[1],
                        longTerm: false,
                        important: false,
                        memory: null,
                        emotionDelta: { affection: 5, trust: 5, friendship: 5 }
                      };
                    }
                  }
                }
              }
            }
          }
          
          // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã‚’å‡¦ç†ï¼ˆemotionDelta ãŒä¸å®Œå…¨ãªå ´åˆï¼‰
          if (isTruncated && (!parsed || !parsed.emotionDelta || 
              typeof parsed.emotionDelta !== 'object' ||
              parsed.emotionDelta.affection === undefined)) {
            
            console.log('ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã‚’æ¤œå‡ºã€æ‰‹å‹•ã§æ§‹ç¯‰ã—ã¾ã™');
            
            // replyã‚’æŠ½å‡º
            let extractedReply = "";
            if (parsed && parsed.reply) {
              extractedReply = parsed.reply;
            } else {
              const replyMatch = replyRaw.match(/"reply":\s*"([^"]*)(?:"|$)/);
              if (replyMatch && replyMatch[1]) {
                extractedReply = replyMatch[1];
              } else {
                // JSONå½¢å¼ã§ãªã„ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨
                extractedReply = replyRaw.substring(0, 200);
              }
            }
            
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†æ§‹ç¯‰ï¼ˆemotionDeltaã«ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã¨ã—ã¦5ã‚’ä½¿ç”¨ï¼‰
            parsed = {
              reply: extractedReply,
              longTerm: false,
              important: false,
              memory: null,
              emotionDelta: { affection: 5, trust: 5, friendship: 5 } // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ï¼šAPIã‹ã‚‰ã®å¿œç­”ãŒå¾—ã‚‰ã‚Œãªã„å ´åˆã«ä½¿ç”¨
            };
          }
          
          console.log("ğŸ§  ãƒ‘ãƒ¼ã‚¹çµæœï¼š", parsed);

          // å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if (!parsed || (!parsed.reply && !parsed.response)) {
            // JSONãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆ
            
            // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã®å ´åˆ
            if (isTruncated) {
              // replyéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦ä½¿ç”¨
              const replyMatch = replyRaw.match(/"reply":\s*"([^"]*)(?:"|$)/);
              if (replyMatch) {
                const extractedText = replyMatch[1];
                parsed = {
                  reply: extractedText + "...", // çœç•¥è¨˜å·ã‚’è¿½åŠ 
                  longTerm: false,
                  important: false,
                  memory: null,
                  emotionDelta: { affection: 5, trust: 5, friendship: 5 } // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ï¼šAPIã‹ã‚‰ã®å¿œç­”ãŒå¾—ã‚‰ã‚Œãªã„å ´åˆã«ä½¿ç”¨
                };
              } else {
                // JSONå½¢å¼ã§ãªã„ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨
                parsed = {
                  reply: replyRaw.substring(0, 200) + "...",
                  longTerm: false,
                  important: false,
                  memory: null,
                  emotionDelta: { affection: 5, trust: 5, friendship: 5 } // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
                };
              }
            } else {
              // ç”Ÿã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹å ´åˆ
              const plainText = replyRaw.replace(/[\{\}"]/g, "")
                               .replace(/reply:/, "")
                               .replace(/longTerm:.*/, "")
                               .trim();
              
              parsed = {
                reply: plainText || "å¿œç­”ã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã§ã—ãŸ",
                longTerm: false,
                important: false,
                memory: null,
                emotionDelta: { affection: 0, trust: 0, friendship: 0 } // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰å‹•ãªã—
              };
            }
          }

          // responseãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆã¯replyã«ã‚³ãƒ”ãƒ¼
          if (parsed.response && !parsed.reply) {
            parsed.reply = parsed.response;
          }
          
          // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã®å ´åˆã€æœ«å°¾ã«çœç•¥è¨˜å·ã‚’è¿½åŠ 
          if (isTruncated && parsed.reply && !parsed.reply.endsWith("...")) {
            parsed.reply = parsed.reply + "...";
          }

          // äºŒé‡å¼•ç”¨ç¬¦ã‚’æ—¥æœ¬èªã®å¼•ç”¨ç¬¦ã«ç½®æ›
          if (parsed.reply) {
            parsed.reply = parsed.reply.replace(/"([^"]*)"/g, 'ã€Œ$1ã€');
          }

        } catch (e) {
          console.error("JSONè§£æã‚¨ãƒ©ãƒ¼:", e);
          console.error("è§£æå¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ:", replyRaw);
          
          // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ä¿å­˜
          errorLogger.logError(e, {
            apiResponse: data,
            rawResponse: replyRaw,
            userMessage: msg,
            memoryCheck: useMemoryCheck,
            isTruncated: isTruncated
          });
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† - ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‹ã‚‰æŠ½å‡ºã‚’è©¦ã¿ã‚‹
          let cleanText = replyRaw;
          
          // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã®å ´åˆ
          if (isTruncated) {
            // ã§ãã‚‹ã ã‘æœ‰ç”¨ãªãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
            if (replyRaw.includes('"reply": "')) {
              const replyMatch = replyRaw.match(/"reply": "([^"]*)$/);
              if (replyMatch) {
                cleanText = replyMatch[1] + "...";
              }
            }
          } 
          // JSONå½¢å¼ã£ã½ã„éƒ¨åˆ†ãŒã‚ã‚Œã°é™¤å»
          else if (replyRaw.includes('{') && replyRaw.includes('}')) {
            // JSONã‚‰ã—ãéƒ¨åˆ†ã‚’å–ã‚Šé™¤ã„ã¦ã€ç´”ç²‹ãªãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’æŠ½å‡º
            const textParts = replyRaw.split('{');
            if (textParts.length > 0 && textParts[0].trim()) {
              cleanText = textParts[0].trim();
            } else if (replyRaw.includes('"reply":')) {
              // replyéƒ¨åˆ†ã‚’æŠ½å‡º
              const replyMatch = replyRaw.match(/"reply"\s*:\s*"([^"]*)"/);
              if (replyMatch && replyMatch[1]) {
                cleanText = replyMatch[1];
              }
            }
          }
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          parsed = {
            reply: cleanText,
            longTerm: false,
            important: false,
            memory: null,
            emotionDelta: { affection: 0, trust: 0, friendship: 0 }
          };

          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã®ã¯ã€æŠ½å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆãŒå…ƒã®replyRawã¨ã»ã¼åŒã˜å ´åˆã®ã¿
          // ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã«æˆåŠŸã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„
          if (isDebugMode() && (cleanText === replyRaw || cleanText.length < 20)) {
            document.getElementById("messages").innerHTML += `
              <div class="message assistant" style="opacity: 0.5;">
                <div class="bubble" style="background: rgba(255,0,0,0.1);">
                  âš ï¸ å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸï¼š${e.message}<br>
                  <small>é–‹ç™ºè€…å‘ã‘ï¼šã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>
                </div>
              </div>`;
          }
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’è¨˜éŒ²
        if (data.usage && data.usage.total_tokens) {
          // æœ€æ–°ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã¨ã—ã¦ä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ç”¨ï¼‰
          dataStore.setItem("last_token_usage", JSON.stringify({
            prompt_tokens: data.usage.prompt_tokens || 0,
            completion_tokens: data.usage.completion_tokens || 0,
            total_tokens: data.usage.total_tokens || 0,
            timestamp: new Date().toISOString()
          }));
          
          // é›†è¨ˆç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚‚ä¿å­˜
          tokenTracker.saveTokenUsage(data.usage.total_tokens);
          
          // å¤‰æ›´ã‚’å³æ™‚ä¿å­˜
          dataStore.flushChanges();
          
          if (isDebugMode()) {
            updateTokenUsageDisplay();
          }
        }

        // --- æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿æ›´æ–°ã¨ä¿å­˜ ---
        // æ„Ÿæƒ…å¤‰å‹•ã‚’ä¿å­˜ï¼ˆå†é€ä¿¡æ™‚ã®ç›¸æ®ºç”¨ï¼‰
        if (parsed.emotionDelta && typeof parsed.emotionDelta === 'object') {
          // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã•ã‚ŒãŸæ„Ÿæƒ…å¤‰å‹•ã‚’è¨ˆç®—
          const scaledEmotionDelta = {
            affection: 0,
            trust: 0,
            friendship: 0
          };
          
          // å„æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
          if (typeof parsed.emotionDelta.affection === 'number') {
            scaledEmotionDelta.affection = scaleEmotionValue(parsed.emotionDelta.affection);
          }
          if (typeof parsed.emotionDelta.trust === 'number') {
            scaledEmotionDelta.trust = scaleEmotionValue(parsed.emotionDelta.trust);
          }
          if (typeof parsed.emotionDelta.friendship === 'number') {
            scaledEmotionDelta.friendship = scaleEmotionValue(parsed.emotionDelta.friendship);
          }
          
          // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¾Œã®å€¤ã‚’last_emotion_deltaã«ä¿å­˜
          dataStore.setItem("last_emotion_delta", JSON.stringify(scaledEmotionDelta));
          
          // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿æ›´æ–°
          if (typeof parsed.emotionDelta.affection === 'number') {
            updateParam("affection", parsed.emotionDelta.affection);
          }
          if (typeof parsed.emotionDelta.trust === 'number') {
            updateParam("trust", parsed.emotionDelta.trust);
          }
          if (typeof parsed.emotionDelta.friendship === 'number') {
            updateParam("friendship", parsed.emotionDelta.friendship);
          }
        } else {
          console.warn("emotionDeltaãŒä¸æ­£ãªå½¢å¼ã§ã™:", parsed.emotionDelta);
          dataStore.setItem("last_emotion_delta", JSON.stringify({
            affection: 0,
            trust: 0,
            friendship: 0
          }));
        }

        // --- é•·æœŸè¨˜æ†¶ä¿å­˜ ---
        if (parsed.longTerm && parsed.memory && parsed.memory !== "null") {
          saveToChatStory(parsed.memory);
        }

        // --- è¡¨ç¤ºï¼ˆ1å›ã ã‘ï¼‰ ---
        let safeResponse = typeof parsed.reply === "string" && parsed.reply.trim()
          ? parsed.reply
          : "ï¼ˆå¿œç­”å†…å®¹ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰";

        // æ–‡ç« ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèª - ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã§åˆ‡ã‚ŒãŸå ´åˆã®ã¿å‡¦ç†
        if (isTruncated && !safeResponse.endsWith('...')) {
          // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã®å ´åˆã®ã¿ã€çœç•¥è¨˜å·ã‚’è¿½åŠ 
          safeResponse = safeResponse + "...";
        }
        // æ³¨ï¼šãã®ä»–ã®æ–‡æœ«åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥ï¼ˆUIã®åˆ¶é™ã«ã‚ˆã‚‹åˆ‡ã‚Šè©°ã‚ã‚’é˜²æ­¢ï¼‰
        
        // ç”»é¢ã«ã‚­ãƒ£ãƒ©è¿”ç­”ã‚’è¡¨ç¤º
        document.getElementById("messages").innerHTML += `
        <div class="message assistant">
          <div class="bubble">${safeResponse}</div>
        </div>`;
        scrollToBottom();

        // ä¼šè©±å±¥æ­´ã«ä¿å­˜ - ç”Ÿã®å¿œç­”ã§ã¯ãªãã€æŠ½å‡ºæ¸ˆã¿ã®å®‰å…¨ãªãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
        saveMessage("assistant", safeResponse);

        // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
        document.getElementById("userInput").focus();

        // çŸ­æœŸè¨˜æ†¶ã®æ›´æ–°ï¼ˆéåŒæœŸã§å®Ÿè¡Œï¼‰- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å¼•æ•°ã«è¿½åŠ 
        if (!isRegenMode) {
          // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§çŸ­æœŸè¨˜æ†¶ã‚’æ›´æ–°
          summarizeShortTermMemory(safeResponse, msg).catch(err => {
            console.error("çŸ­æœŸè¨˜æ†¶æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
          });
          
          // ç›´è¿‘ä¼šè©±åœ§ç¸®ã‚‚æ›´æ–°
          compressRecentDialogue().catch(err => {
            console.error("ç›´è¿‘ä¼šè©±åœ§ç¸®ã‚¨ãƒ©ãƒ¼:", err);
          });
        }

        // --- useMemoryCheckæ™‚ã®è¿½åŠ å‡¦ç†ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰ ---
        if (useMemoryCheck && !isRegenMode) {  // å†ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—
          try {
            // å¿µã®ãŸã‚å†ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚‚è¡¨ç¤ºã¯ã—ãªã„ï¼ˆè¡¨ç¤ºæ¸ˆã¿ï¼‰
            const match = replyRaw.match(/\{[\s\S]*\}/);
            const debugParsed = match ? JSON.parse(match[0]) : JSON.parse(replyRaw);

            // memoryã¨keywordsã®ã¿å†å‡¦ç†
            if (
              (debugParsed.longTerm || debugParsed.important) &&
              debugParsed.memory &&
              debugParsed.memory !== "null"
            ) {
              saveToChatStory(debugParsed.memory);
            }

            dataStore.setItem("last_keywords", JSON.stringify(debugParsed.keywords || []));
          } catch (err) {
            console.warn("useMemoryCheckç”¨å†ãƒ‘ãƒ¼ã‚¹å¤±æ•—:", err);
          }

          // ğŸ’­ä¼šè©±å†…å®¹ã®ã¾ã¨ã‚ï¼ˆå†ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          await summarizeMemoryFromRecentChats();
        }
        
        // æœ€å¾Œã«é€ä¿¡ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨ä½“ã‚’ä¿å­˜
        dataStore.setItem("last_prompt_content", JSON.stringify(messages.map(m => ({
          role: m.role,
          content: m.content
        }))));

      } catch (err) {
        console.error("APIé€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById(typingId)?.remove();
        
        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ä¿å­˜
        errorLogger.logError(err, {
          userMessage: msg,
          memoryCheck: useMemoryCheck
        });
        
        document.getElementById("messages").innerHTML += `<div class="message assistant"><div class="bubble">âš ï¸ ã‚¨ãƒ©ãƒ¼: ${err.message}</div></div>`;
        scrollToBottom();
      }
    }

    async function handleOverwriteCommand(commandText) {
      const apiKey = dataStore.getItem("openai_api_key");
      const story = JSON.parse(dataStore.getItem("chat_story") || "[]");

      // ğŸ”” ä¸€æ™‚è¡¨ç¤ºï¼ˆè¨˜æ†¶æ›´æ–°ä¸­ï¼‰
      // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ–¹å¼ï¼‰
      const tempId = "mem-update-temp-" + Date.now();

      // è¡¨ç¤º
      document.getElementById("messages").innerHTML += `
    <div class="message assistant" id="${tempId}">
      <div class="bubble">ğŸ’­ è¨˜æ†¶ã‚’æ›´æ–°ä¸­ã§ã™...</div>
    </div>`;
      scrollToBottom();

      const prompt = `
ã‚ãªãŸã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¨˜æ†¶ã‚’ç®¡ç†ã™ã‚‹AIã§ã™ã€‚
ä»¥ä¸‹ã®è¨˜æ†¶ãƒªã‚¹ãƒˆï¼ˆé…åˆ—ï¼‰ã‚’ã‚‚ã¨ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä¸ãˆã‚‰ã‚ŒãŸæŒ‡ç¤ºã«å¾“ã£ã¦
ä¿®æ­£ãŒå¿…è¦ãªè¨˜æ†¶ã‚’æ›´æ–°ãƒ»æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã€‘
${commandText}

ã€ç¾åœ¨ã®è¨˜æ†¶ã€‘
${JSON.stringify(story, null, 2)}

ã€å‡ºåŠ›å½¢å¼ã€‘
["ä¿®æ­£æ¸ˆã¿ã®è¨˜æ†¶1", "è¨˜æ†¶2", "è¨˜æ†¶3", ...]`;

      try {
        const messages = [{ role: "system", content: prompt }];
        
        const data = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.5, 300);
        });

        if (data.error) {
          throw new Error(data.error);
        }

        const reply = data.choices[0].message.content.trim();
        const match = reply.match(/\[.*\]/s);
        if (!match) throw new Error("JSONå½¢å¼ã§è¿”ã£ã¦ãã¾ã›ã‚“ã§ã—ãŸ");
        const updated = JSON.parse(match[0]);
        if (!Array.isArray(updated)) throw new Error("å½¢å¼ãŒä¸æ­£ã§ã™");

        dataStore.setItem("chat_story", JSON.stringify(updated));
        document.getElementById(tempId).innerHTML = `<div class="bubble">âœ… è¨˜æ†¶ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚</div>`;
        scrollToBottom();
      } catch (err) {
        console.error("overwriteå¤±æ•—:", err);
        document.getElementById(tempId).innerHTML = `<div class="bubble">âš ï¸ è¨˜æ†¶ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</div>`;
        scrollToBottom();
      }
    }

    // keywordsã‹ã‚‰è¨˜æ†¶æŠ½å‡ºã™ã‚‹é–¢æ•°ï¼ˆJSå´ï¼‰
    function extractRelevantMemoriesByKeywords(keywords) {
      const story = JSON.parse(dataStore.getItem("chat_story") || "[]");
      if (!Array.isArray(story) || !Array.isArray(keywords)) return [];

      return story.filter(m =>
        keywords.some(k => typeof m === "string" && m.toLowerCase().includes(k))
      );
    }

    //é•·æœŸè¨˜æ†¶åœ§ç¸®å‡¦ç†é–¢æ•°
    async function handleCompressMemoryCommand() {
      const apiKey = dataStore.getItem("openai_api_key");
      const story = JSON.parse(dataStore.getItem("chat_story") || "[]");
      if (!story.length) {
        alert("é•·æœŸè¨˜æ†¶ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼");
        return;
      }

      // ğŸ’¬ UIè¡¨ç¤ºï¼šè¦ç´„ä¸­â€¦
      const compressId = "compress-indicator";
      document.getElementById("messages").innerHTML += `
    <div class="message assistant" id="${compressId}">
      <div class="bubble">ğŸ§  è¦ç´„ä¸­ã§ã™...</div>
    </div>`;
      scrollToBottom();

      try {
        const messages = [
          { role: "system", content: compressPrompt },
          { role: "user", content: story.join("\n") }
        ];
        
        const data = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.5, 200);
        });

        if (data.error) {
          throw new Error(data.error);
        }

        const reply = data.choices[0].message.content;
        const match = reply.match(/\{[\s\S]*?\}/);
        if (!match) throw new Error("JSONãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

        const parsed = JSON.parse(match[0]);
        if (parsed.summary && typeof parsed.summary === "string") {
          // ğŸ”„ ä¿å­˜ã—ç›´ã—
          dataStore.setItem("chat_story", JSON.stringify([parsed.summary]));
          document.getElementById(compressId).innerHTML = `<div class="bubble">âœ… è¦ç´„å®Œäº†ï¼š<br>${parsed.summary}</div>`;
        } else {
          throw new Error("summaryãŒç©ºã§ã™");
        }

      } catch (e) {
        console.warn("åœ§ç¸®å¤±æ•—:", e);
        document.getElementById(compressId).innerHTML = `<div class="bubble">âš ï¸ è¦ç´„ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦<br>${e.message}</div>`;
      }
    }

    function resetCharacterData() {
      // ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã—ãªã„ãŸã‚å‰Šé™¤
    }
    
    function resetCharacterDataClientOnly() {
      if (!confirm("æœ¬å½“ã«ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿï¼ˆä¼šè©±å±¥æ­´ãƒ»è¨˜æ†¶ãƒ»æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿ãƒ»ã‚­ãƒ£ãƒ©è¨­å®šï¼‰")) return;

      // APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ãŠã
      const apiKey = dataStore.getItem("openai_api_key");
      
      // ãƒªã‚»ãƒƒãƒˆå¯¾è±¡ã®ã‚­ãƒ¼ã‚’ç‰¹å®šï¼ˆcharacter_promptã‚‚å«ã‚ã‚‹ï¼‰
      const resetKeys = [
        "chat_history", "chat_story", "memory_counter", "last_keywords", 
        "char_name", "char_personality", "character_prompt", "char_self",
        "affection", "trust", "friendship", "last_emotion_delta",
        "story_mode", "avatar_url", "short_term_memory", "known_facts", "recent_dialogue_compressed"
      ];
      
      // å‰Šé™¤å‡¦ç†ã®å®Œäº†ã‚’è¿½è·¡
      let deleteCount = 0;
      const totalKeys = resetKeys.length;
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã®ä¸¡æ–¹ã‚’ã‚¯ãƒªã‚¢
      resetKeys.forEach(key => {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
        if (dataStore.cache) {
          dataStore.cache[key] = null;
        }
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‹ã‚‰å‰Šé™¤ï¼ˆremoveItemã‚’ä½¿ç”¨ï¼‰
        dataStore.removeItem(key);
        deleteCount++;
      });
      
      // chat_storyã¯ç©ºã®é…åˆ—ã¨ã—ã¦å†åˆæœŸåŒ–ï¼ˆnullã§ã¯ãªã[]ï¼‰
      dataStore.setItem("chat_story", "[]");
      if (dataStore.cache) {
        dataStore.cache["chat_story"] = "[]";
      }
      
      // APIã‚­ãƒ¼ã‚’å†è¨­å®š
      if (apiKey) {
        dataStore.setItem("openai_api_key", apiKey);
      }
      
      // å‰Šé™¤å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰UIæ›´æ–°
      setTimeout(() => {
        // UIæ›´æ–°
        updateUIAfterReset();
        
        // å‰Šé™¤å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        alert("ã‚­ãƒ£ãƒ©ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼\n\nã‚‚ã—å¤ã„ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
        
        // ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã®ç¢ºèª
        if (confirm("ç¢ºå®Ÿã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã‹ï¼Ÿ")) {
          location.reload();
        }
      }, 1000); // 1ç§’å¾…ã£ã¦ã‹ã‚‰å‡¦ç†
    }
    
    // ãƒªã‚»ãƒƒãƒˆå¾Œã®UIæ›´æ–°ã‚’å…±é€šåŒ–
    function updateUIAfterReset() {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¬„ã‚’ã‚¯ãƒªã‚¢
      document.getElementById("messages").innerHTML = "";
      
      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆ
      document.getElementById("charPrompt").value = "åå‰ï¼šæ€§åˆ¥ã€ç‰¹å¾´";
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚‚ä¿æŒ
      const savedCharSelf = dataStore.getItem("char_self");
      if (savedCharSelf) {
        document.getElementById("charSelfSetting").value = savedCharSelf;
      } else {
        document.getElementById("charSelfSetting").value = "";
      }
      
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’ä¿æŒ
      const storyMode = dataStore.getItem("story_mode") === "1";
      document.getElementById("storyModeToggle").checked = storyMode;
      
      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã¯ä¿æŒ
      const avatarUrl = dataStore.getItem("avatar_url");
      if (avatarUrl) {
        document.getElementById("character-bg").src = avatarUrl;
      }
      
      // æ—¢çŸ¥æƒ…å ±ã¯åˆæœŸåŒ–ï¼ˆãƒªã‚»ãƒƒãƒˆå¯¾è±¡ã®ãŸã‚ï¼‰
      const knownFactsInput = document.getElementById("knownFactsInput");
      if (knownFactsInput) {
        knownFactsInput.value = "";
      }
      
      // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ›´æ–°
      renderEmotionParams();
      
      console.log("UIæ›´æ–°å®Œäº†: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    }

    //ï¼ˆ1000ã‚¹ã‚±ãƒ¼ãƒ«ç”¨ï¼‰
    function getEmotionRank(value) {
      const num = Number(value);
      if (num >= 900) return "A";	// Aãƒ©ãƒ³ã‚¯ï¼šéå¸¸ã«å¼·ã„å¥½æ„ãƒ»ä¿¡é ¼ï¼ˆãƒ©ãƒ–åº¦MAXï¼‰
      if (num >= 700) return "B";	// Bãƒ©ãƒ³ã‚¯ï¼šå¼·ã„è¦ªã—ã¿ã€æ·±ã„ä¿¡é ¼æ„Ÿ
      if (num >= 500) return "C";	// Cãƒ©ãƒ³ã‚¯ï¼šã‚„ã‚„è¦ªã—ã„ãƒ»å®‰å®šã—ãŸé–¢ä¿‚ï¼ˆä»²è‰¯ã—ã®ä¸€æ­©æ‰‹å‰ï¼‰
      if (num >= 300) return "D";	// Dãƒ©ãƒ³ã‚¯ï¼šå°‘ã—è­¦æˆ’ã€ã¾ã å£ãŒã‚ã‚‹
      if (num >= 0) return "E";  	// Eãƒ©ãƒ³ã‚¯ï¼šåˆå¯¾é¢ãƒ¬ãƒ™ãƒ«ã€ã¾ã è·é›¢ãŒã‚ã‚‹
      if (num >= -1000) return "F";  // Fãƒ©ãƒ³ã‚¯ï¼šè»½ã„æ‹’å¦ã€é•å’Œæ„Ÿã€ã‚ãšã‹ãªæ•µæ„
      return "G";  // Gãƒ©ãƒ³ã‚¯ï¼šå®Œå…¨æ‹’çµ¶ã€æ•µå¯¾ãƒ»å¼·ã„å«Œæ‚ª
    }
    
    // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ—¥æœ¬èªã®è¡¨ç¾ã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function convertAffection(value) {
      const num = Number(value);
      if (num >= 900) return "æ·±ã„å¥½æ„ã‚ã‚Š";
      if (num >= 700) return "å¥½æ„ã‚ã‚Š";
      if (num >= 500) return "ã‚„ã‚„å¥½æ„çš„";
      if (num >= 300) return "åˆå¯¾é¢ç¨‹åº¦";
      if (num >= 100) return "å°‘ã—è­¦æˆ’ä¸­";
      return "å¼·ã„æ‹’çµ¶";
    }
    
    function convertTrust(value) {
      const num = Number(value);
      if (num >= 900) return "å®Œå…¨ä¿¡é ¼ä¸­";
      if (num >= 700) return "é«˜ã„ä¿¡é ¼";
      if (num >= 500) return "å°‘ã—ä¿¡é ¼ã‚ã‚Š";
      if (num >= 300) return "ä¸­ç«‹";
      if (num >= 100) return "ã‚„ã‚„ä¸ä¿¡æ„Ÿ";
      return "å¼·ãç–‘ã£ã¦ã„ã‚‹";
    }
    
    function convertFriendship(value) {
      const num = Number(value);
      if (num >= 900) return "è¦ªå‹ã«è¿‘ã„";
      if (num >= 700) return "æ‰“ã¡è§£ã‘ã¦ã„ã‚‹";
      if (num >= 500) return "ä¼šè©±ã—ã‚„ã™ã„";
      if (num >= 300) return "åˆå¯¾é¢ãƒ¬ãƒ™ãƒ«";
      if (num >= 100) return "æ‰“ã¡è§£ã‘ã¦ã„ãªã„";
      return "è·é›¢ã‚’ç½®ã„ã¦ã„ã‚‹";
    }
    
    //ï¼ˆä¸Šé™10000ã§åˆ¶å¾¡ï¼‰
    function updateParam(key, delta) {
      const current = Number(dataStore.getItem(key) || "0");
      
      // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‰ã®å€¤ã‚’ä¿å­˜
      const originalDelta = delta;
      
      // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é–¢æ•°ã§è¨ˆç®—
      let scaledDelta = scaleEmotionValue(delta);
      
      // 1000ã§å‰²ã£ã¦å¢—æ¸›ç‡ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆï¼‰ã‚’è¨ˆç®—
      const increaseRatePercent = ((scaledDelta / 1000) * 100).toFixed(1);
      
      // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å‰å¾Œã®å€¤ã¨å¢—æ¸›ç‡ã‚’last_emotion_delta_scaledã«ä¿å­˜
      try {
        const lastEmotionDelta = JSON.parse(dataStore.getItem("last_emotion_delta_scaled") || "{}");
        lastEmotionDelta[`${key}_original`] = originalDelta;
        lastEmotionDelta[`${key}_scaled`] = scaledDelta;
        lastEmotionDelta[`${key}_rate`] = increaseRatePercent;
        dataStore.setItem("last_emotion_delta_scaled", JSON.stringify(lastEmotionDelta));
      } catch (e) {
        console.warn("ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æƒ…å ±ã®ä¿å­˜ã«å¤±æ•—:", e);
      }

      // æ„Ÿæƒ…å€¤ãŒé«˜ã„ã¨ãã¯ä¸Šæ˜‡ç‡ã‚’éˆåŒ–ã•ã›ã‚‹ï¼ˆè² ã®å¤‰å‹•ã¯ãã®ã¾ã¾ï¼‰
      let adjusted = scaledDelta;
      if (scaledDelta > 0) {
        if (current >= 9000) {
          adjusted = Math.round(scaledDelta * 0.2);
          console.log(`ğŸ”„ é«˜æ„Ÿæƒ…å€¤éˆåŒ–(9000+): ${scaledDelta} Ã— 0.2 = ${adjusted}`);
        } else if (current >= 8000) {
          adjusted = Math.round(scaledDelta * 0.5);
          console.log(`ğŸ”„ é«˜æ„Ÿæƒ…å€¤éˆåŒ–(8000+): ${scaledDelta} Ã— 0.5 = ${adjusted}`);
        }
      }

      const newVal = Math.max(0, Math.min(10000, current + adjusted));
      console.log(`ğŸ“Š æ„Ÿæƒ…å€¤æ›´æ–° ${key}: ${current} + ${adjusted} = ${newVal}`);
      dataStore.setItem(key, newVal.toString());
    }
    
    //é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤ºã®ãªã«ã‹
    function toggleDevMode() {
      const dev = document.getElementById("devMode");
      const devToggle = document.getElementById("devToggle");
      const isActive = dev.style.display === "none" || !dev.style.display;

      // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      dev.style.display = isActive ? "block" : "none";
      
      // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ
      if (isActive) {
        devToggle.classList.add("active");
        dataStore.setItem("dev_mode", "1");

        // é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹éš›ã¯å¿…ãšãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚ªãƒ•ã«
        dataStore.setItem("debug_mode", "0");
        document.getElementById("debugToggle").checked = false;
        renderEmotionParams();
      } else {
        devToggle.classList.remove("active");
        dataStore.setItem("dev_mode", "0");
      }
    }
    
    //é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ã®ä¸­ã®ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰é–¢ä¿‚
    function updateDebugMode() {
      const enabled = document.getElementById("debugToggle").checked;
      dataStore.setItem("debug_mode", enabled ? "1" : "0");
      renderEmotionParams(); // çŠ¶æ…‹ãŒå¤‰ã‚ã£ãŸã‚‰å†æç”»
      updateTokenUsageDisplay(); // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡è¡¨ç¤ºã‚‚æ›´æ–°
      
      // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤ºã‚‚æ›´æ–°
      if (enabled) {
        errorLogger.updateErrorLogDisplay();
        updateGpt4oLogsDisplay(); // GPT-4oãƒ­ã‚°ã‚‚æ›´æ–°
      } else {
        document.getElementById("errorLogArea").style.display = "none";
      }
      
      // GPT-4oãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ã®è¡¨ç¤º/éè¡¨ç¤º
      const gpt4oLogsArea = document.getElementById("gpt4oLogsArea");
      if (gpt4oLogsArea) {
        gpt4oLogsArea.style.display = enabled ? "block" : "none";
      }
    }

    function isDebugMode() {
      return dataStore.getItem("debug_mode") === "1";
    }

    function renderEmotionParams() {
      const aff = dataStore.getItem("affection") || "0";
      const tr = dataStore.getItem("trust") || "0";
      const fr = dataStore.getItem("friendship") || "0";

      const emotionBlock = (label, val, emoji) => {
        const rank = getEmotionRank(val);
        const detailId = `${label.toLowerCase()}-detail`;
        let html = `${emoji} ${label}ï¼š${rank}`;

        if (isDebugMode()) {
          html += ` <button onclick="toggleEmotionDetail('${detailId}', '${label}', '${val}')">â–¶ è©³ç´°</button>`;
          html += ` <span id="${detailId}" style="display:none; margin-left:5px; color:#aaa;">${val} / 10000</span>`;
        }

        return `<div style="margin-bottom:0.3rem;">${html}</div>`;
      };

      const emotionHTML = `
        <b style="color:#ccc;">ç¾åœ¨ã®æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿</b><br><br>
        ${emotionBlock("affection", aff, "â¤ï¸")}
        ${emotionBlock("trust", tr, "ğŸ¤")}
        ${emotionBlock("friendship", fr, "ğŸŒˆ")}
      `;

      // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¨ãƒªã‚¢ã‚’æ›´æ–°
      document.getElementById("emotionParamsArea").innerHTML = emotionHTML;

      // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
      const tokenUsageArea = document.getElementById("tokenUsageArea");
      if (tokenUsageArea) {
        tokenUsageArea.style.display = isDebugMode() ? "block" : "none";
        if (isDebugMode()) {
          updateTokenUsageDisplay();
        }
      }
    }

    // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è©³ç´°è¡¨ç¤ºåˆ‡æ›¿æ©Ÿèƒ½
    function toggleEmotionDetail(detailId, label, value) {
      const detailElement = document.getElementById(detailId);
      if (detailElement) {
        detailElement.style.display = detailElement.style.display === "none" ? "inline" : "none";
      }
    }

    function toggleQuickActions() {
      const panel = document.getElementById("quickActionsPanel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
    }

    async function handleQuickAction(action) {
      const messages = JSON.parse(dataStore.getItem("chat_history") || "[]");
      const lastUser = [...messages].reverse().find(m => m.role === "user");
      const lastBot = [...messages].reverse().find(m => m.role === "assistant");

      if (!lastBot || !lastUser) {
        alert("å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
        return;
      }

      switch (action) {
        case "save":
          saveMessageToMemoryWithSummary(lastBot.content);
          break;
        case "editBot":
          // é•·æœŸè¨˜æ†¶ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ç¢ºèª
          if (getMemoryCounter() % 10 === 0) {
            if (!confirm("âš ï¸ ç¾åœ¨ã¯é•·æœŸè¨˜æ†¶ã®ç™»éŒ²ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚\né•·æœŸè¨˜æ†¶ä¿®æ­£ã«ã¨ã‚‚ãªã„ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ãŒç™ºç”Ÿã—ã¾ã™ãŒã€ç¶šã‘ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
              break;
            }
            // ç›´å‰ã®é•·æœŸè¨˜æ†¶ã‚’å‰Šé™¤
            removeLastMemory();
          }

          const newBot = prompt("ã‚­ãƒ£ãƒ©ã®è¿”äº‹ã‚’ä¿®æ­£ï¼š", lastBot.content);
          if (newBot) {
            lastBot.content = newBot;
            dataStore.setItem("chat_history", JSON.stringify(messages));
            
            // é•·æœŸè¨˜æ†¶ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãªã‚‰å†ç™»éŒ²
            if (getMemoryCounter() % 10 === 0) {
              summarizeMemoryFromRecentChats();
            }
            
            location.reload();
          }
          break;
        case "editUser":
          const newUser = prompt("è‡ªåˆ†ã®ç™ºè¨€ã‚’ä¿®æ­£ï¼š", lastUser.content);
          if (newUser) {
            // ç›´å‰ã®æ„Ÿæƒ…å¤‰å‹•ã‚’å–å¾—ã—ã¦ç›¸æ®º
            try {
              const lastDelta = JSON.parse(dataStore.getItem("last_emotion_delta") || "{}");
              if (lastDelta && typeof lastDelta === 'object') {
                // æ„Ÿæƒ…å€¤ã‚’ç›¸æ®ºï¼ˆãƒã‚¤ãƒŠã‚¹æ–¹å‘ã«é©ç”¨ï¼‰
                if (typeof lastDelta.affection === 'number') {
                  updateParam("affection", -lastDelta.affection);
                }
                if (typeof lastDelta.trust === 'number') {
                  updateParam("trust", -lastDelta.trust);
                }
                if (typeof lastDelta.friendship === 'number') {
                  updateParam("friendship", -lastDelta.friendship);
                }
              }
            } catch (e) {
              console.warn("æ„Ÿæƒ…å€¤ã®ç›¸æ®ºã«å¤±æ•—:", e);
            }

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†é€ä¿¡
            lastUser.content = newUser;
            dataStore.setItem("chat_history", JSON.stringify(messages));
            
            // å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆã—ã¦é€ä¿¡ï¼ˆlocation.reloadã¯ä½¿ã‚ãªã„ï¼‰
            document.getElementById("userInput").value = newUser;
            sendMessage();
          }
          break;
        case "editLastMessage":
          // æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã—ã¦å†é€ä¿¡
          await editLastMessage();
          break;
        case "regen":
          // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          showRegenPromptModal();
          break;
      }

      toggleQuickActions(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‰ã˜ã‚‹
    }
    
    // æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†ã—ã¦å†é€ä¿¡ã™ã‚‹é–¢æ•°
    async function editLastMessage() {
      const messages = JSON.parse(dataStore.getItem("chat_history") || "[]");
      const lastUser = [...messages].reverse().find(m => m.role === "user");
      const lastBot = [...messages].reverse().find(m => m.role === "assistant");
      
      if (!lastBot || !lastUser) {
        alert("å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
        return;
      }
      
      const newUserMessage = prompt("æœ€æ–°ã®ç™ºè¨€ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„:", lastUser.content);
      if (!newUserMessage || newUserMessage === lastUser.content) {
        return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯å¤‰æ›´ãªã—
      }
      
      // æ„Ÿæƒ…å€¤ã®ç›¸æ®ºï¼ˆç›´å‰ã®ä¼šè©±ã®å½±éŸ¿ã‚’æ‰“ã¡æ¶ˆã™ï¼‰
      try {
        const lastDelta = JSON.parse(dataStore.getItem("last_emotion_delta") || "{}");
        if (lastDelta && typeof lastDelta === 'object') {
          // æ„Ÿæƒ…å€¤ã‚’ç›¸æ®ºï¼ˆãƒã‚¤ãƒŠã‚¹æ–¹å‘ã«é©ç”¨ï¼‰
          if (typeof lastDelta.affection === 'number') {
            updateParam("affection", -lastDelta.affection);
          }
          if (typeof lastDelta.trust === 'number') {
            updateParam("trust", -lastDelta.trust);
          }
          if (typeof lastDelta.friendship === 'number') {
            updateParam("friendship", -lastDelta.friendship);
          }
        }
      } catch (e) {
        console.warn("æ„Ÿæƒ…å€¤ã®ç›¸æ®ºã«å¤±æ•—:", e);
      }
      
      // ä¼šè©±å±¥æ­´ã‹ã‚‰æœ€å¾Œã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      for (let i = messages.length - 1; i >= 0; i--) {
        if (messages[i].role === "assistant") {
          messages.splice(i, 1);
          break;
        }
      }
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
      for (let i = messages.length - 1; i >= 0; i--) {
        if (messages[i].role === "user") {
          messages[i].content = newUserMessage;
          break;
        }
      }
      
      // æ›´æ–°ã—ãŸå±¥æ­´ã‚’ä¿å­˜
      dataStore.setItem("chat_history", JSON.stringify(messages));
      
      // UIã‚’æ›´æ–°
      loadHistory();
      
      // å†ç”Ÿæˆ
      await regenerateAssistantMessage(newUserMessage);
    }
    
    // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®è¿”ç­”ã‚’å†ç”Ÿæˆã™ã‚‹é–¢æ•°
    async function regenerateAssistantMessage(userMessage) {
      // ãƒ¡ãƒ¢ãƒªãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¢—åŠ ã‚’ç„¡åŠ¹åŒ–
      window.allowMemoryIncrement = false;
      
      // é•·æœŸè¨˜æ†¶ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å ´åˆã€å‰ã®è¨˜æ†¶ã‚’å‰Šé™¤
      if (getMemoryCounter() % 10 === 0) {
        removeLastMemory();
      }
      
      try {
        const typingId = "bot-typing";
        document.getElementById("messages").innerHTML += `
        <div class="message assistant" id="${typingId}">
          <div class="bubble">å…¥åŠ›ä¸­ã§ã™...</div>
        </div>`;
        scrollToBottom();
        
        const apiKey = dataStore.getItem("openai_api_key");
        if (!apiKey) {
          throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        }
        
        const useMemoryCheck = getMemoryCounter() % 10 === 0;
        const messages = buildMessages(userMessage);
        
        // APIå‘¼ã³å‡ºã—
        const data = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.7, 1800); // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã‚’1800ã«è¨­å®š
        });
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã‚’æ¤œå‡ºï¼ˆfinish_reason="length"ï¼‰
        const isTruncated = data.choices[0].finish_reason === "length";
        
        let replyRaw = data.choices[0].message.content.trim();
        
        // å…¥åŠ›ä¸­è¡¨ç¤ºå‰Šé™¤
        document.getElementById(typingId)?.remove();
        
        // JSONãƒ‘ãƒ¼ã‚¹å‡¦ç† - æ”¹å–„ç‰ˆ
        let parsed;
        try {
          // JSONã®éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆè¤‡æ•°è¡Œå¯¾å¿œï¼‰- æ”¹å–„ç‰ˆ
          let jsonStr = "";
          
          // JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™ - æ­£è¦è¡¨ç¾ã‚’å¼·åŒ–
          const jsonMatch = replyRaw.match(/\{[\s\S]*?\}/g);
          if (jsonMatch && jsonMatch.length > 0) {
            // æœ€é•·ã®JSONã‚’ä½¿ç”¨ï¼ˆæœ€ã‚‚å®Œå…¨ãªå½¢å¼ã§ã‚ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ï¼‰
            jsonStr = jsonMatch.reduce((a, b) => a.length > b.length ? a : b);
            
            try {
              parsed = JSON.parse(jsonStr);
            } catch (e) {
              console.warn("æœ€åˆã®JSONè§£æã«å¤±æ•—ã€ä¿®å¾©ã‚’è©¦ã¿ã¾ã™:", e);
              
              // ä¸å®Œå…¨ãªJSONã®ä¿®å¾©ã‚’è©¦ã¿ã‚‹
              if (jsonStr.includes('"emotionDelta": {') && !jsonStr.includes('}}}')) {
                // emotionDeltaã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ãªã„å ´åˆ
                
                // è¶³ã‚Šãªã„é–‰ã˜æ‹¬å¼§ã®æ•°ã‚’æ¨å®š
                let openBraces = (jsonStr.match(/\{/g) || []).length;
                let closeBraces = (jsonStr.match(/\}/g) || []).length;
                let missingBraces = openBraces - closeBraces;
                
                // è¶³ã‚Šãªã„é–‰ã˜æ‹¬å¼§ã‚’è¿½åŠ 
                let fixedJson = jsonStr;
                for (let i = 0; i < missingBraces; i++) {
                  fixedJson += '}';
                }
                
                console.log('ä¿®å¾©ã—ãŸJSON:', fixedJson);
                try {
                  parsed = JSON.parse(fixedJson);
                } catch (innerErr) {
                  console.warn("æ‹¬å¼§è£œå®Œä¿®å¾©ã«å¤±æ•—:", innerErr);
                  
                  // emotionDelta ã®å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã™ã‚‹ãŒå€¤ãŒæ¬ ã‘ã¦ã„ã‚‹å ´åˆ
                  if (jsonStr.includes('"affection":') && jsonStr.includes('"trust":')) {
                    // æ‰‹å‹•ã§ emotionDelta ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
                    const affectionMatch = jsonStr.match(/"affection":\s*(\d+)/);
                    const trustMatch = jsonStr.match(/"trust":\s*(\d+)/);
                    const friendshipMatch = jsonStr.match(/"friendship":\s*(\d+)/);
                    
                    // åŸºæœ¬çš„ãªæ§‹é€ ã‚’æ§‹ç¯‰
                    const manualObj = {
                      reply: "",
                      longTerm: false,
                      important: false,
                      memory: null,
                      emotionDelta: {
                        affection: affectionMatch ? parseInt(affectionMatch[1]) : 5,
                        trust: trustMatch ? parseInt(trustMatch[1]) : 5,
                        friendship: friendshipMatch ? parseInt(friendshipMatch[1]) : 5
                      }
                    };
                    
                    // replyã‚’æŠ½å‡º
                    const replyMatch = jsonStr.match(/"reply":\s*"([^"]*)"/);
                    if (replyMatch && replyMatch[1]) {
                      manualObj.reply = replyMatch[1];
                    }
                    
                    parsed = manualObj;
                  }
                }
              } else if (jsonStr.includes('"reply": "') && !jsonStr.includes('"}')) {
                // replyéƒ¨åˆ†ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ãªã„å ´åˆ
                const replyMatch = jsonStr.match(/"reply":\s*"([^"]*)$/);
                if (replyMatch) {
                  // é–‰ã˜æ‹¬å¼§ã‚’è¿½åŠ 
                  const fixedJson = jsonStr + '"}';
                  console.log('ä¿®å¾©ã—ãŸJSON (reply):', fixedJson);
                  try {
                    parsed = JSON.parse(fixedJson);
                  } catch (innerErr) {
                    // è¿½åŠ ã®ä¿®å¾©ãŒå¿…è¦ãªå ´åˆ
                    const moreFixedJson = fixedJson + '}';
                    console.log('è¿½åŠ ä¿®å¾©ã—ãŸJSON:', moreFixedJson);
                    try {
                      parsed = JSON.parse(moreFixedJson);
                    } catch (deepErr) {
                      // æ‰‹å‹•ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹ç¯‰
                      parsed = {
                        reply: replyMatch[1],
                        longTerm: false,
                        important: false,
                        memory: null,
                        emotionDelta: { affection: 5, trust: 5, friendship: 5 }
                      };
                    }
                  }
                }
              }
            }
          }
          
          // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã‚’å‡¦ç†ï¼ˆemotionDelta ãŒä¸å®Œå…¨ãªå ´åˆï¼‰
          if (isTruncated && (!parsed || !parsed.emotionDelta || 
              typeof parsed.emotionDelta !== 'object' ||
              parsed.emotionDelta.affection === undefined)) {
            
            console.log('ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã‚’æ¤œå‡ºã€æ‰‹å‹•ã§æ§‹ç¯‰ã—ã¾ã™');
            
            // replyã‚’æŠ½å‡º
            let extractedReply = "";
            if (parsed && parsed.reply) {
              extractedReply = parsed.reply;
            } else {
              const replyMatch = replyRaw.match(/"reply":\s*"([^"]*)(?:"|$)/);
              if (replyMatch && replyMatch[1]) {
                extractedReply = replyMatch[1];
              } else {
                // JSONå½¢å¼ã§ãªã„ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨
                extractedReply = replyRaw.substring(0, 200);
              }
            }
            
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†æ§‹ç¯‰ï¼ˆemotionDeltaã«ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã¨ã—ã¦5ã‚’ä½¿ç”¨ï¼‰
            parsed = {
              reply: extractedReply,
              longTerm: false,
              important: false,
              memory: null,
              emotionDelta: { affection: 5, trust: 5, friendship: 5 } // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ï¼šAPIã‹ã‚‰ã®å¿œç­”ãŒå¾—ã‚‰ã‚Œãªã„å ´åˆã«ä½¿ç”¨
            };
          }
          
          // å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if (!parsed || (!parsed.reply && !parsed.response)) {
            // JSONãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€ã¾ãŸã¯å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆ
            
            // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã®å ´åˆ
            if (isTruncated) {
              // replyéƒ¨åˆ†ã‚’æŠ½å‡ºã—ã¦ä½¿ç”¨
              const replyMatch = replyRaw.match(/"reply":\s*"([^"]*)(?:"|$)/);
              if (replyMatch) {
                const extractedText = replyMatch[1];
                parsed = {
                  reply: extractedText + "...", // çœç•¥è¨˜å·ã‚’è¿½åŠ 
                  longTerm: false,
                  important: false,
                  memory: null,
                  emotionDelta: { affection: 5, trust: 5, friendship: 5 } // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ï¼šAPIã‹ã‚‰ã®å¿œç­”ãŒå¾—ã‚‰ã‚Œãªã„å ´åˆã«ä½¿ç”¨
                };
              } else {
                // JSONå½¢å¼ã§ãªã„ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨
                parsed = {
                  reply: replyRaw.substring(0, 200) + "...",
                  longTerm: false,
                  important: false,
                  memory: null,
                  emotionDelta: { affection: 5, trust: 5, friendship: 5 } // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤
                };
              }
            } else {
              // ç”Ÿã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹å ´åˆ
              const plainText = replyRaw.replace(/[\{\}"]/g, "")
                               .replace(/reply:/, "")
                               .replace(/longTerm:.*/, "")
                               .trim();
              
              parsed = {
                reply: plainText || "å¿œç­”ã‚’å‡¦ç†ã§ãã¾ã›ã‚“ã§ã—ãŸ",
                longTerm: false,
                important: false,
                memory: null,
                emotionDelta: { affection: 0, trust: 0, friendship: 0 } // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰å‹•ãªã—
              };
            }
          }
          
          // responseãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆã¯replyã«ã‚³ãƒ”ãƒ¼
          if (parsed.response && !parsed.reply) {
            parsed.reply = parsed.response;
          }
          
          // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã®å ´åˆã€æœ«å°¾ã«çœç•¥è¨˜å·ã‚’è¿½åŠ 
          if (isTruncated && parsed.reply && !parsed.reply.endsWith("...")) {
            parsed.reply = parsed.reply + "...";
          }
          
          // äºŒé‡å¼•ç”¨ç¬¦ã‚’æ—¥æœ¬èªã®å¼•ç”¨ç¬¦ã«ç½®æ›
          if (parsed.reply) {
            parsed.reply = parsed.reply.replace(/"([^"]*)"/g, 'ã€Œ$1ã€');
          }
          
        } catch (e) {
          console.error("JSONè§£æã‚¨ãƒ©ãƒ¼:", e);
          console.error("è§£æå¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ:", replyRaw);
          
          // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ä¿å­˜
          errorLogger.logError(e, {
            apiResponse: data,
            rawResponse: replyRaw,
            userMessage: userMessage,
            memoryCheck: useMemoryCheck,
            isTruncated: isTruncated
          });
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† - ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã‹ã‚‰æŠ½å‡ºã‚’è©¦ã¿ã‚‹
          let cleanText = replyRaw;
          
          // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã®å ´åˆ
          if (isTruncated) {
            // ã§ãã‚‹ã ã‘æœ‰ç”¨ãªãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
            if (replyRaw.includes('"reply": "')) {
              const replyMatch = replyRaw.match(/"reply": "([^"]*)$/);
              if (replyMatch) {
                cleanText = replyMatch[1] + "...";
              }
            }
          } 
          // JSONå½¢å¼ã£ã½ã„éƒ¨åˆ†ãŒã‚ã‚Œã°é™¤å»
          else if (replyRaw.includes('{') && replyRaw.includes('}')) {
            // JSONã‚‰ã—ãéƒ¨åˆ†ã‚’å–ã‚Šé™¤ã„ã¦ã€ç´”ç²‹ãªãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’æŠ½å‡º
            const textParts = replyRaw.split('{');
            if (textParts.length > 0 && textParts[0].trim()) {
              cleanText = textParts[0].trim();
            } else if (replyRaw.includes('"reply":')) {
              // replyéƒ¨åˆ†ã‚’æŠ½å‡º
              const replyMatch = replyRaw.match(/"reply"\s*:\s*"([^"]*)"/);
              if (replyMatch && replyMatch[1]) {
                cleanText = replyMatch[1];
              }
            }
          }
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
          parsed = {
            reply: cleanText,
            longTerm: false,
            important: false,
            memory: null,
            emotionDelta: { affection: 0, trust: 0, friendship: 0 }
          };
          
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã®ã¯ã€æŠ½å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆãŒå…ƒã®replyRawã¨ã»ã¼åŒã˜å ´åˆã®ã¿
          // ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã«æˆåŠŸã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„
          if (isDebugMode() && (cleanText === replyRaw || cleanText.length < 20)) {
            document.getElementById("messages").innerHTML += `
              <div class="message assistant" style="opacity: 0.5;">
                <div class="bubble" style="background: rgba(255,0,0,0.1);">
                  âš ï¸ å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸï¼š${e.message}<br>
                  <small>é–‹ç™ºè€…å‘ã‘ï¼šã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>
                </div>
              </div>`;
          }
        }
        
        // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’è¨˜éŒ²
        if (data.usage && data.usage.total_tokens) {
          // æœ€æ–°ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã¨ã—ã¦ä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ç”¨ï¼‰
          dataStore.setItem("last_token_usage", JSON.stringify({
            prompt_tokens: data.usage.prompt_tokens || 0,
            completion_tokens: data.usage.completion_tokens || 0,
            total_tokens: data.usage.total_tokens || 0,
            timestamp: new Date().toISOString()
          }));
          
          // é›†è¨ˆç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚‚ä¿å­˜
          tokenTracker.saveTokenUsage(data.usage.total_tokens);
          
          // å¤‰æ›´ã‚’å³æ™‚ä¿å­˜
          dataStore.flushChanges();
          
          if (isDebugMode()) {
            updateTokenUsageDisplay();
          }
        }
        
        // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿æ›´æ–°ã¨ä¿å­˜
        if (parsed.emotionDelta && typeof parsed.emotionDelta === 'object') {
          // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã•ã‚ŒãŸæ„Ÿæƒ…å¤‰å‹•ã‚’è¨ˆç®—
          const scaledEmotionDelta = {
            affection: 0,
            trust: 0,
            friendship: 0
          };
          
          // å„æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
          if (typeof parsed.emotionDelta.affection === 'number') {
            scaledEmotionDelta.affection = scaleEmotionValue(parsed.emotionDelta.affection);
          }
          if (typeof parsed.emotionDelta.trust === 'number') {
            scaledEmotionDelta.trust = scaleEmotionValue(parsed.emotionDelta.trust);
          }
          if (typeof parsed.emotionDelta.friendship === 'number') {
            scaledEmotionDelta.friendship = scaleEmotionValue(parsed.emotionDelta.friendship);
          }
          
          // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¾Œã®å€¤ã‚’last_emotion_deltaã«ä¿å­˜
          dataStore.setItem("last_emotion_delta", JSON.stringify(scaledEmotionDelta));
          
          // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿æ›´æ–°
          if (typeof parsed.emotionDelta.affection === 'number') {
            updateParam("affection", parsed.emotionDelta.affection);
          }
          if (typeof parsed.emotionDelta.trust === 'number') {
            updateParam("trust", parsed.emotionDelta.trust);
          }
          if (typeof parsed.emotionDelta.friendship === 'number') {
            updateParam("friendship", parsed.emotionDelta.friendship);
          }
        } else {
          console.warn("emotionDeltaãŒä¸æ­£ãªå½¢å¼ã§ã™:", parsed.emotionDelta);
          dataStore.setItem("last_emotion_delta", JSON.stringify({
            affection: 0,
            trust: 0,
            friendship: 0
          }));
        }
        
        // é•·æœŸè¨˜æ†¶ä¿å­˜
        if (parsed.longTerm && parsed.memory && parsed.memory !== "null") {
          saveToChatStory(parsed.memory);
        }
        
        // è¡¨ç¤ºï¼ˆ1å›ã ã‘ï¼‰
        let safeResponse = typeof parsed.reply === "string" && parsed.reply.trim()
          ? parsed.reply
          : "ï¼ˆå¿œç­”å†…å®¹ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰";
        
        // æ–‡ç« ãŒé€”ä¸­ã§åˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèª - ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã§åˆ‡ã‚ŒãŸå ´åˆã®ã¿å‡¦ç†
        if (isTruncated && !safeResponse.endsWith('...')) {
          // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«ã‚ˆã‚‹åˆ‡æ–­ã®å ´åˆã®ã¿ã€çœç•¥è¨˜å·ã‚’è¿½åŠ 
          safeResponse = safeResponse + "...";
        }
        // æ³¨ï¼šãã®ä»–ã®æ–‡æœ«åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥ï¼ˆUIã®åˆ¶é™ã«ã‚ˆã‚‹åˆ‡ã‚Šè©°ã‚ã‚’é˜²æ­¢ï¼‰
        
        // ç”»é¢ã«ã‚­ãƒ£ãƒ©è¿”ç­”ã‚’è¡¨ç¤º
        document.getElementById("messages").innerHTML += `
        <div class="message assistant">
          <div class="bubble">${safeResponse}</div>
        </div>`;
        scrollToBottom();
        
        // ä¼šè©±å±¥æ­´ã«ä¿å­˜ - ç”Ÿã®å¿œç­”ã§ã¯ãªãã€æŠ½å‡ºæ¸ˆã¿ã®å®‰å…¨ãªãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
        saveMessage("assistant", safeResponse);
        
        // useMemoryCheckæ™‚ã®è¿½åŠ å‡¦ç†
        if (useMemoryCheck) {
          try {
            // å¿µã®ãŸã‚å†ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚‚è¡¨ç¤ºã¯ã—ãªã„ï¼ˆè¡¨ç¤ºæ¸ˆã¿ï¼‰
            const match = replyRaw.match(/\{[\s\S]*\}/);
            const debugParsed = match ? JSON.parse(match[0]) : JSON.parse(replyRaw);
            
            // memoryã¨keywordsã®ã¿å†å‡¦ç†
            if (
              (debugParsed.longTerm || debugParsed.important) &&
              debugParsed.memory &&
              debugParsed.memory !== "null"
            ) {
              saveToChatStory(debugParsed.memory);
            }
            
            dataStore.setItem("last_keywords", JSON.stringify(debugParsed.keywords || []));
          } catch (err) {
            console.warn("useMemoryCheckç”¨å†ãƒ‘ãƒ¼ã‚¹å¤±æ•—:", err);
          }
          
          // ä¼šè©±å†…å®¹ã®ã¾ã¨ã‚
          await summarizeMemoryFromRecentChats();
        }
        
        // çŸ­æœŸè¨˜æ†¶ã®æ›´æ–°ï¼ˆéåŒæœŸã§å®Ÿè¡Œï¼‰- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å¼•æ•°ã«è¿½åŠ 
        summarizeShortTermMemory(safeResponse, userMessage).catch(err => {
          console.error("çŸ­æœŸè¨˜æ†¶æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
        });
        
        // ç›´è¿‘ä¼šè©±åœ§ç¸®ã‚‚æ›´æ–°ï¼ˆå†ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã®ã¿ï¼‰
        if (!isRegenMode) {
          compressRecentDialogue().catch(err => {
            console.error("ç›´è¿‘ä¼šè©±åœ§ç¸®ã‚¨ãƒ©ãƒ¼:", err);
          });
        }
        
      } catch (err) {
        console.error("å†ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById("messages").innerHTML += `
        <div class="message assistant">
          <div class="bubble">âš ï¸ ã‚¨ãƒ©ãƒ¼: ${err.message}</div>
        </div>`;
        scrollToBottom();
      } finally {
        window.allowMemoryIncrement = true;
        document.getElementById("userInput").focus();
      }
      
      // æœ€å¾Œã«é€ä¿¡ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨ä½“ã‚’ä¿å­˜
      dataStore.setItem("last_prompt_content", JSON.stringify(messages.map(m => ({
        role: m.role,
        content: m.content
      }))));
    }
    
    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®æ›´æ–°
    function updateStoryMode() {
      const enabled = document.getElementById("storyModeToggle").checked;
      dataStore.setItem("story_mode", enabled ? "1" : "0");
      
      // æƒ…å ±è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById("storyModeInfo").style.display = enabled ? "block" : "none";
      
      // æ¿ƒåº¦é¸æŠUIã®è¡¨ç¤º/éè¡¨ç¤º
      document.getElementById("storyIntensitySelector").style.display = enabled ? "block" : "none";
      
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒªãƒ¼ãƒ‰ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å¿…ãšè¡¨ç¤ºï¼ˆè¿½åŠ ï¼‰
      if (enabled) {
        const storySliderContainer = document.querySelector('#storyIntensitySelector > div:last-child');
        if (storySliderContainer) {
          storySliderContainer.style.display = "block";
        }
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’è¨­å®š
        applyStoryLeadProbability();
      }
    }
    
    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’åæ˜ 
    function applyStoryMode() {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ONã«ã™ã‚‹ (ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ãŒæ˜ç¤ºçš„ã« "0" ã®å ´åˆã®ã¿OFF)
      const isStoryMode = dataStore.getItem("story_mode") !== "0";
      
      // ã‚‚ã—æœªè¨­å®šãªã‚‰æ˜ç¤ºçš„ã« "1" ã‚’ä¿å­˜ã™ã‚‹
      if (!dataStore.getItem("story_mode")) {
        dataStore.setItem("story_mode", "1");
      }
      
      document.getElementById("storyModeToggle").checked = isStoryMode;
      document.getElementById("storyModeInfo").style.display = isStoryMode ? "block" : "none";
      document.getElementById("storyIntensitySelector").style.display = isStoryMode ? "block" : "none";
      
      // æ¿ƒåº¦è¨­å®šã®åæ˜ 
      applyStoryIntensity();
      
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒªãƒ¼ãƒ‰ç¢ºç‡ã®åæ˜ 
      applyStoryLeadProbability();
      
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒªãƒ¼ãƒ‰ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å¿…ãšè¡¨ç¤ºï¼ˆè¿½åŠ ï¼‰
      const storySliderContainer = document.querySelector('#storyIntensitySelector > div:last-child');
      if (storySliderContainer) {
        storySliderContainer.style.display = "block";
      }
    }
    
    // ç‰©èªæ¿ƒåº¦ã®è¨­å®š
    function setStoryIntensity(intensity) {
      dataStore.setItem("story_intensity", intensity);
      applyStoryIntensity();
    }
    
    // ç‰©èªæ¿ƒåº¦ã®çŠ¶æ…‹ã‚’åæ˜ 
    function applyStoryIntensity() {
      const intensity = dataStore.getItem("story_intensity") || "medium";
      
      // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
      document.getElementById("intensityMedium").classList.toggle("active", intensity === "medium");
      document.getElementById("intensityHigh").classList.toggle("active", intensity === "high");
      
      // èª¬æ˜æ–‡ã‚’æ›´æ–°
      let infoText = "";
      if (intensity === "medium") {
        infoText = "ãƒŸãƒ‰ãƒ«ï¼š400æ–‡å­—ç¨‹åº¦ã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸç‰©èªæå†™";
      } else if (intensity === "high") {
        infoText = "ãƒã‚¤ï¼š600ã€œ800æ–‡å­—ã€æ–‡èŠ¸çš„ã§æ˜ åƒçš„ãªè±Šã‹ãªæå†™";
      }
      document.getElementById("intensityInfo").textContent = infoText;
    }

    // å†ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    window.userPromptOverride = null;

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºåˆ¶å¾¡
    function showRegenPromptModal() {
      document.getElementById("regenerateModal").style.display = "block";
      document.getElementById("regenPrompt").value = "";
    }

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function hideRegenPromptModal() {
      document.getElementById("regenerateModal").style.display = "none";
    }

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ã®å‡¦ç†
    async function handleRegenPrompt(isOK) {
      hideRegenPromptModal();
      
      if (!isOK) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ä½•ã‚‚ã—ãªã„
      
      const promptText = document.getElementById("regenPrompt").value.trim();
      window.userPromptOverride = promptText; // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜
      
      // æ—¢å­˜ã®å†ç”Ÿæˆå‡¦ç†ã‚’å®Ÿè¡Œ
      await executeRegeneration();
      
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¯ãƒªã‚¢
      window.userPromptOverride = null;
    }

    // å†ç”Ÿæˆã®å®Ÿè¡Œå‡¦ç†ï¼ˆæ—¢å­˜å‡¦ç†ã‚’é–¢æ•°ã¨ã—ã¦åˆ†é›¢ï¼‰
    async function executeRegeneration() {
      // é•·æœŸè¨˜æ†¶ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ç¢ºèª
      if (getMemoryCounter() % 10 === 0) {
        if (!confirm("âš ï¸ ç¾åœ¨ã¯é•·æœŸè¨˜æ†¶ã®ç™»éŒ²ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã™ã€‚\né•·æœŸè¨˜æ†¶ä¿®æ­£ã«ã¨ã‚‚ãªã„ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ãŒç™ºç”Ÿã—ã¾ã™ãŒã€ç¶šã‘ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
          return;
        }
        removeLastMemory();
      }

      // æ„Ÿæƒ…å€¤ã®ç›¸æ®º
      try {
        const lastDelta = JSON.parse(dataStore.getItem("last_emotion_delta") || "{}");
        if (lastDelta && typeof lastDelta === 'object') {
          // æ„Ÿæƒ…å€¤ã‚’ç›¸æ®ºï¼ˆãƒã‚¤ãƒŠã‚¹æ–¹å‘ã«é©ç”¨ï¼‰
          if (typeof lastDelta.affection === 'number') {
            updateParam("affection", -lastDelta.affection);
          }
          if (typeof lastDelta.trust === 'number') {
            updateParam("trust", -lastDelta.trust);
          }
          if (typeof lastDelta.friendship === 'number') {
            updateParam("friendship", -lastDelta.friendship);
          }
        }
      } catch (e) {
        console.warn("æ„Ÿæƒ…å€¤ã®ç›¸æ®ºã«å¤±æ•—:", e);
      }

      // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‹ã‚‰æœ€å¾Œã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
      try {
        let history = JSON.parse(dataStore.getItem("chat_history") || "[]");
        for (let i = history.length - 1; i >= 0; i--) {
          if (history[i].role === "assistant") {
            history.splice(i, 1);
            break;
          }
        }
        dataStore.setItem("chat_history", JSON.stringify(history));
        loadHistory();
      } catch (e) {
        console.warn("å±¥æ­´ã®æ›´æ–°ã«å¤±æ•—:", e);
      }

      // ãƒ¡ãƒ¢ãƒªãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¢—åŠ ã‚’ç„¡åŠ¹åŒ–
      window.allowMemoryIncrement = false;

      try {
        const messages = JSON.parse(dataStore.getItem("chat_history") || "[]");
        const lastUser = [...messages].reverse().find(m => m.role === "user");
        
        if (lastUser) {
          document.getElementById("userInput").value = lastUser.content;
          await sendMessage(true);

          if (getMemoryCounter() % 10 === 0) {
            await summarizeMemoryFromRecentChats();
          }
        }
      } catch (e) {
        console.error("å†ç”Ÿæˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:", e);
      } finally {
        window.allowMemoryIncrement = true;
      }
    }

    // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ç®¡ç†ç”¨ã®é–¢æ•°ç¾¤
    const tokenTracker = {
      // è¨­å®šå€¤
      TOKENS_PER_USD: 2000000,  // 0.0000005 USD/token ã®é€†æ•°
      JPY_PER_USD: 150,         // ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ
      GPT4O_TOKENS_PER_USD: 250000, // 0.000004 USD/token ã®é€†æ•° (GPT-4oç”¨)

      // æœˆåˆæ—¥ã®å–å¾—ãƒ»è¨­å®š
      getStartDay() {
        return Number(dataStore.getItem("token_track_start_day") || "1");
      },
      setStartDay(day) {
        dataStore.setItem("token_track_start_day", String(Math.min(28, Math.max(1, day))));
      },

      // ç¾åœ¨ã®é›†è¨ˆæœŸé–“ã®é–‹å§‹æ—¥ã‚’å–å¾—
      getCurrentPeriodStart() {
        const now = new Date();
        const startDay = this.getStartDay();
        const year = now.getFullYear();
        const month = now.getMonth();
        
        // ç¾åœ¨æ—¥ãŒé–‹å§‹æ—¥ã‚ˆã‚Šå‰ãªã‚‰å‰æœˆã®é–‹å§‹æ—¥
        if (now.getDate() < startDay) {
          return new Date(year, month - 1, startDay);
        }
        return new Date(year, month, startDay);
      },

      // ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ãƒ­ã‚°ã®ä¿å­˜
      saveTokenUsage(tokens, model = "gpt-4.1-mini") {
        try {
          const now = new Date().toISOString();
          const logs = JSON.parse(dataStore.getItem("token_usage_logs") || "[]");
          
          logs.push({ date: now, tokens, model });
          console.log("ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ãƒ­ã‚°ã‚’ä¿å­˜:", { date: now, tokens, model }, "åˆè¨ˆ:", logs.length);
            
          dataStore.setItem("token_usage_logs", JSON.stringify(logs));
        } catch (e) {
          console.error("ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ãƒ­ã‚°ã®ä¿å­˜ã«å¤±æ•—:", e);
        }
      },

      // ç¾åœ¨æœŸé–“ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’è¨ˆç®—
      getCurrentPeriodTokens(modelFilter = null) {
        const logs = JSON.parse(dataStore.getItem("token_usage_logs") || "[]");
        const startDate = this.getCurrentPeriodStart();
        
        return logs
          .filter(log => new Date(log.date) >= startDate)
          .filter(log => !modelFilter || log.model === modelFilter)
          .reduce((sum, log) => sum + log.tokens, 0);
      },

      // å††æ›ç®—ï¼ˆå°æ•°ç‚¹ä»¥ä¸‹2æ¡ã¾ã§ï¼‰
      calculateJPY(tokens, model = "gpt-4.1-mini") {
        const rate = model === "gpt-4o" ? this.GPT4O_TOKENS_PER_USD : this.TOKENS_PER_USD;
        return ((tokens / rate) * this.JPY_PER_USD).toFixed(2);
      },
      
      // GPT-4oã®ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ20ä»¶ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤ï¼‰
      cleanupOldLogs() {
        try {
          const logs = JSON.parse(dataStore.getItem("gpt4o_logs") || "[]");
          if (logs.length > 20) {
            logs.splice(0, logs.length - 20);
            dataStore.setItem("gpt4o_logs", JSON.stringify(logs));
          }
        } catch (e) {
          console.error("ãƒ­ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:", e);
        }
      }
    };

    // é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰å†…ã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡è¡¨ç¤ºã‚’æ›´æ–°
    function updateTokenUsageDisplay() {
      if (!isDebugMode()) return;

      const startDate = tokenTracker.getCurrentPeriodStart();
      const totalTokens = tokenTracker.getCurrentPeriodTokens();
      const totalGpt41Tokens = tokenTracker.getCurrentPeriodTokens("gpt-4.1-mini");
      const totalGpt4oTokens = tokenTracker.getCurrentPeriodTokens("gpt-4o");
      
      const costJPY = tokenTracker.calculateJPY(totalTokens);
      const costGpt41JPY = tokenTracker.calculateJPY(totalGpt41Tokens, "gpt-4.1-mini");
      const costGpt4oJPY = tokenTracker.calculateJPY(totalGpt4oTokens, "gpt-4o");
      
      const startDay = tokenTracker.getStartDay();

      const usageHTML = `
        <div class="token-usage">
          <h4>ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³åˆ©ç”¨çŠ¶æ³</h4>
          
          <div class="form-group">
            <label>ğŸ“… é›†è¨ˆé–‹å§‹æ—¥</label>
            <div class="input-group">
              <input type="number" 
                value="${startDay}" 
                min="1" max="28" 
                class="form-input"
                style="width: 80px;"
                onchange="tokenTracker.setStartDay(this.value); updateTokenUsageDisplay();">
              <span style="margin-left: 0.5rem; color: #aaa;">æ—¥</span>
            </div>
          </div>

          <div class="token-stats">
            <div class="stat-item">
              <label>ğŸ§® ä»Šæœˆã®åˆè¨ˆ</label>
              <div class="stat-value">${totalTokens.toLocaleString()} tokens</div>
            </div>
            <div class="stat-item">
              <label>ğŸ’¸ æ¦‚ç®—è²»ç”¨</label>
              <div class="stat-value">ç´„${costJPY}å††</div>
            </div>
          </div>
          
          <div class="token-model-breakdown">
            <div class="model-usage">
              <label>GPT-4.1mini:</label>
              <div>${totalGpt41Tokens.toLocaleString()} tokens (ç´„${costGpt41JPY}å††)</div>
            </div>
            <div class="model-usage">
              <label>GPT-4o:</label>
              <div>${totalGpt4oTokens.toLocaleString()} tokens (ç´„${costGpt4oJPY}å††)</div>
            </div>
          </div>

          <div class="token-period">
            é›†è¨ˆæœŸé–“ï¼š${startDate.toLocaleDateString()} ï½ ç¾åœ¨
          </div>
        </div>
      `;

      document.getElementById("tokenUsageArea").innerHTML = usageHTML;
    }

    async function saveMessageToMemoryWithSummary(text) {
      const apiKey = dataStore.getItem("openai_api_key");
      if (!apiKey) {
        alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const prompt = `
ä»¥ä¸‹ã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚»ãƒªãƒ•ã§ã™ã€‚
ã“ã‚Œã‚’ã€é•·æœŸçš„ãªè¨˜æ†¶ã¨ã—ã¦æ®‹ã™ãŸã‚ã«ç°¡æ½”ãª1ã€œ2æ–‡ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚

è¿”ç­”ã¯ä»¥ä¸‹ã®å½¢å¼ã§ã€JSONã®ã¿ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

{
  "summary": "è¨˜æ†¶ã«é©ã—ãŸè¦ç´„æ–‡"
}

ã‚»ãƒªãƒ•ï¼š
ã€Œ${text}ã€
`;

      try {
        const messages = [{ role: "system", content: prompt }];
        
        const data = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .callOpenAI(apiKey, messages, model, 0.3, 150);
        });

        if (data.error) {
          throw new Error(data.error);
        }

        const reply = data.choices[0].message.content;
        const match = reply.match(/\{[\s\S]*?\}/);
        if (!match) throw new Error("JSONãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

        const parsed = JSON.parse(match[0]);
        if (parsed.summary) {
          saveToChatStory(parsed.summary);
          alert("âœ… è¦ç´„ã—ã¦è¨˜æ†¶ã«ä¿å­˜ã—ã¾ã—ãŸï¼");
        } else {
          throw new Error("summaryãŒç©ºã§ã™");
        }

      } catch (e) {
        console.error("è¨˜æ†¶ä¿å­˜å¤±æ•—:", e);
        alert("âš ï¸ è¦ç´„ãƒ»è¨˜æ†¶ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
      }
    }

    // GASç”¨ã®ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    window.addEventListener('load', function() {
      console.log("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹");
      
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
      dataStore.initialize(() => {
        try {
          console.log("åˆæœŸåŒ–ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ");
          
        // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã®å‡¦ç†
          
          // ä¼šè©±å±¥æ­´ã®ä¿®å¾©ã‚’è©¦ã¿ã‚‹
          repairChatHistory();
          
        loadHistory();
          applyStoryMode();

        // è¨­å®šç”»é¢ã®åˆæœŸå€¤ã‚’è¨­å®š
        document.getElementById("charPrompt").value = dataStore.getItem("character_prompt") || "";
        document.getElementById("charSelfSetting").value = dataStore.getItem("char_self") || "";
        document.getElementById("apiKey").value = dataStore.getItem("openai_api_key") || "";

        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®š
          if (!dataStore.getItem("character_prompt")) {
            document.getElementById("charPrompt").value = `åå‰ï¼šæ€§åˆ¥ã€ç‰¹å¾´`;
        }

        renderEmotionParams();
        document.getElementById("debugToggle").checked = isDebugMode();
          
          // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªã‚‰ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤ºã‚’æ›´æ–°
          if (isDebugMode()) {
            errorLogger.updateErrorLogDisplay();
          }
          
          // ãƒ•ã‚©ãƒˆãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
          const photoMode = dataStore.getItem("photo_mode") === "1";
          if (photoMode) {
            document.body.classList.add('photo-mode');
            document.getElementById('character-bg').style.opacity = "1";
            document.querySelector('.photo-mode-toggle').style.background = "#2196F3";
          }
        
        // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        document.getElementById("userInput").addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
              // Shift+Enterã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆé€šå¸¸ã®å‹•ä½œã‚’è¨±å¯ï¼‰
              if (e.shiftKey) {
                return;
              }
              
              // é€šå¸¸ã®Enterã‚­ãƒ¼ã®å ´åˆã¯æ”¹è¡Œã‚’æŒ¿å…¥ã™ã‚‹
            e.preventDefault();
              
              // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«æ”¹è¡Œã‚’æŒ¿å…¥
              const textarea = this;
              const start = textarea.selectionStart;
              const end = textarea.selectionEnd;
              const value = textarea.value;
              
              textarea.value = value.substring(0, start) + "\n" + value.substring(end);
              
              // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ”¹è¡Œå¾Œã«è¨­å®š
              textarea.selectionStart = textarea.selectionEnd = start + 1;
          }
        });
        } catch (e) {
          console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
          alert("åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
        }
      });
    });

    // ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    function toggleDataViewer() {
      const modal = document.getElementById("dataViewerModal");
      const isVisible = modal.style.display === "block";
      
      if (isVisible) {
        modal.style.display = "none";
      } else {
        updateDataViewer();
        modal.style.display = "block";
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆé–²è¦§/ç·¨é›†ï¼‰
    function switchDataViewerMode(mode) {
      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.getElementById('viewModeBtn').classList.toggle('active', mode === 'view');
      document.getElementById('editModeBtn').classList.toggle('active', mode === 'edit');
      
      // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ä¿å­˜
      window.dataViewerMode = mode;
      
      // ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
      updateDataViewer();
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®å†…å®¹ã‚’æ›´æ–°
    function updateDataViewer() {
      const container = document.getElementById("dataViewerContent");
      const allData = dataStore.getAllData();
      const mode = window.dataViewerMode || 'view'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡
      const categories = {
        "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š": ["character_prompt", "char_self", "avatar_url"],
        "æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿": ["affection", "trust", "friendship", "last_emotion_delta", "last_emotion_delta_scaled", "emotionInitialValues"],
        "è¨˜æ†¶ãƒ»å±¥æ­´": ["chat_story", "chat_history", "last_keywords", "memory_counter", "short_term_memory", "recent_dialogue_compressed"],
        "è¡¨ç¤ºè¨­å®š": ["story_mode", "story_intensity", "photo_mode", "bgImageData"],
        "ã‚·ã‚¹ãƒ†ãƒ è¨­å®š": ["openai_api_key", "dev_mode", "debug_mode", "resetEmotionToggle"],
        "åˆ©ç”¨çµ±è¨ˆ": ["token_track_start_day", "token_usage_logs", "last_token_usage"]
      };
      
      // HTMLã‚’ç”Ÿæˆ
      let html = '';
      
      // æœ€æ–°ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã®è¡¨ç¤ºã‚’è¿½åŠ 
      let lastTokenUsage = null;
      try {
        lastTokenUsage = JSON.parse(dataStore.getItem("last_token_usage") || "null");
      } catch (e) {}
      
      if (lastTokenUsage) {
        html += `<div class="data-category">
          <h3 class="data-category-title">ğŸ“Š æœ€æ–°ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡</h3>
          <div class="data-item">
            <div class="data-key">ä½¿ç”¨çŠ¶æ³</div>
            <div class="data-value">
              <div><strong>ä¸Šã‚Š(ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ):</strong> ${lastTokenUsage.prompt_tokens.toLocaleString()} tokens</div>
              <div><strong>ä¸‹ã‚Š(è£œå®Œ):</strong> ${lastTokenUsage.completion_tokens.toLocaleString()} tokens</div>
              <div><strong>åˆè¨ˆ:</strong> ${lastTokenUsage.total_tokens.toLocaleString()} tokens</div>
              <div><small style="color:#888;">${new Date(lastTokenUsage.timestamp).toLocaleString()}</small></div>
            </div>
          </div>
        </div>`;
      }
      
      // æœ€å¾Œã«é€ä¿¡ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã‚’è¡¨ç¤º
      let lastPromptContent = null;
      try {
        lastPromptContent = JSON.parse(dataStore.getItem("last_prompt_content") || "null");
      } catch (e) {}
      
      if (lastPromptContent) {
        html += `<div class="data-category">
          <h3 class="data-category-title">ğŸ“¤ æœ€æ–°é€ä¿¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
          <div class="data-item">
            <div class="data-key">ä¸Šã‚Šãƒ‡ãƒ¼ã‚¿å…¨å†…å®¹</div>
            <div class="data-value" style="max-height: 300px; overflow-y: auto;">`;
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º
        lastPromptContent.forEach((message, index) => {
          const roleColor = message.role === "system" ? "#9c88ff" : 
                             message.role === "user" ? "#4cd137" : 
                             message.role === "assistant" ? "#7f8fa6" : "#f5f6fa";
          
          html += `<div style="margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.2); border-left: 3px solid ${roleColor}; border-radius: 3px;">
            <div style="font-weight: bold; color: ${roleColor}; margin-bottom: 5px;">${message.role}:</div>
            <div style="white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">${escapeHtml(message.content)}</div>
          </div>`;
        });
        
        html += `
            </div>
          </div>
        </div>`;
      }
      
      // APIã‹ã‚‰ã®å¿œç­”ãƒ‡ãƒ¼ã‚¿å…¨ä½“ã‚’è¡¨ç¤ºï¼ˆè¿½åŠ ï¼‰
      let lastApiResponse = null;
      try {
        lastApiResponse = JSON.parse(dataStore.getItem("last_api_response") || "null");
      } catch (e) {}
      
      if (lastApiResponse) {
        html += `<div class="data-category">
          <h3 class="data-category-title">ğŸ“¥ æœ€æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿</h3>
          <div class="data-item">
            <div class="data-key">ä¸‹ã‚Šãƒ‡ãƒ¼ã‚¿å…¨å†…å®¹</div>
            <div class="data-value" style="max-height: 300px; overflow-y: auto;">
              <pre style="margin: 0; white-space: pre-wrap; font-family: monospace; font-size: 0.85em;">${escapeHtml(JSON.stringify(lastApiResponse, null, 2))}</pre>
            </div>
          </div>
        </div>`;
      }
      
      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«è¡¨ç¤º
      for (const [category, keys] of Object.entries(categories)) {
        const categoryItems = keys.filter(key => key in allData);
        
        if (categoryItems.length === 0) continue;
        
        html += `<div class="data-category">
          <h3 class="data-category-title">${category}</h3>`;
        
        for (const key of categoryItems) {
          let value = allData[key];
          let displayValue = value || '';
          
          // å€¤ã®è¡¨ç¤ºå½¢å¼ã‚’æ•´ãˆã‚‹
          if (typeof value === 'string') {
            // APIã‚­ãƒ¼ã¯ä¸€éƒ¨ã‚’éš ã™ï¼ˆé–²è¦§ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
            if (key === 'openai_api_key' && value && mode === 'view') {
              displayValue = value.substring(0, 3) + '...' + value.substring(value.length - 4);
            }
            
            // JSONã®å ´åˆã¯ãã‚Œã„ã«æ•´å½¢ï¼ˆæ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å ´åˆã¯å¢—æ¸›ç‡ã‚‚è¡¨ç¤ºï¼‰
            if ((value.startsWith('{') && value.endsWith('}')) || 
                (value.startsWith('[') && value.endsWith(']'))) {
              try {
                const parsed = JSON.parse(value);
                
                // last_emotion_delta ã®å ´åˆã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¾Œã®å€¤ã‚’è¡¨ç¤º
                if (key === 'last_emotion_delta') {
                  let lastEmotionDeltaScaled = null;
                  try {
                    lastEmotionDeltaScaled = JSON.parse(dataStore.getItem("last_emotion_delta_scaled") || "{}");
                  } catch (e) {}
                  
                  // ç¾åœ¨ã®æ„Ÿæƒ…å€¤ã‚’å–å¾—
                  const currentAffection = Number(dataStore.getItem("affection") || "0");
                  const currentTrust = Number(dataStore.getItem("trust") || "0");
                  const currentFriendship = Number(dataStore.getItem("friendship") || "0");
                  
                  // å¢—æ¸›ç‡ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
                  if (lastEmotionDeltaScaled) {
                    if (parsed.affection !== undefined) {
                      const rate = lastEmotionDeltaScaled.affection_rate || 
                        ((parsed.affection / currentAffection) * 100).toFixed(1);
                      parsed.affection = `${parsed.affection}ï¼ˆå®Ÿè³ª${rate > 0 ? '+' : ''}${rate}%ï¼‰`;
                    }
                    if (parsed.trust !== undefined) {
                      const rate = lastEmotionDeltaScaled.trust_rate || 
                        ((parsed.trust / currentTrust) * 100).toFixed(1);
                      parsed.trust = `${parsed.trust}ï¼ˆå®Ÿè³ª${rate > 0 ? '+' : ''}${rate}%ï¼‰`;
                    }
                    if (parsed.friendship !== undefined) {
                      const rate = lastEmotionDeltaScaled.friendship_rate || 
                        ((parsed.friendship / currentFriendship) * 100).toFixed(1);
                      parsed.friendship = `${parsed.friendship}ï¼ˆå®Ÿè³ª${rate > 0 ? '+' : ''}${rate}%ï¼‰`;
                    }
                  }
                }
                
                displayValue = JSON.stringify(parsed, null, 2);
              } catch (e) {
                // ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯ãã®ã¾ã¾è¡¨ç¤º
              }
            }
            
            // é•·ã„ãƒ‡ãƒ¼ã‚¿URLã¯çœç•¥ï¼ˆé–²è¦§ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
            if (value.startsWith('data:') && value.length > 100 && mode === 'view') {
              displayValue = value.substring(0, 50) + '...' + value.substring(value.length - 20);
            }
          }
          
          html += `<div class="data-item">
            <div class="data-key">${key}</div>`;
          
          if (mode === 'edit') {
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ä¸€æ„ã®IDã‚’æŒã¤ç©ºã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½œæˆ
            const safeKey = key.replace(/[^a-zA-Z0-9]/g, '_');
            html += `
              <textarea class="data-value-editor" id="editor-${safeKey}" data-key="${key}"></textarea>
              <div class="data-edit-controls">
                <button class="data-edit-btn data-edit-save" onclick="saveDataEdit('${key}')">ä¿å­˜</button>
                <button class="data-edit-btn data-edit-cancel" onclick="cancelDataEdit('${key}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </div>
            `;
          } else {
            // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é€šå¸¸è¡¨ç¤º
            html += `<div class="data-value">${displayValue}</div>`;
          }
          
          html += `</div>`;
        }
        
        html += `</div>`;
      }
      
      container.innerHTML = html;
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€å„ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«å€¤ã‚’ç›´æ¥è¨­å®š
      if (mode === 'edit') {
        for (const key of Object.values(categories).flat()) {
          if (key in allData) {
            const value = allData[key] || '';
            const textarea = document.getElementById(`editor-${key.replace(/[^a-zA-Z0-9]/g, '_')}`);
            if (textarea) {
              textarea.value = value;
            }
          }
        }
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ç·¨é›†ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ã‚‚ä¿®æ­£
    function saveDataEdit(key) {
      const textarea = document.getElementById(`editor-${key.replace(/[^a-zA-Z0-9]/g, '_')}`);
      if (!textarea) {
        showNotification(`âš ï¸ ã‚¨ãƒ‡ã‚£ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${key}`, 'error');
        return;
      }
      
      const newValue = textarea.value;
      
      try {
        // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        dataStore.setItem(key, newValue);
        
        // å¤‰æ›´ã‚’å³æ™‚åæ˜ 
        dataStore.flushChanges();
        
        // æˆåŠŸé€šçŸ¥
        showNotification(`âœ… ${key} ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
        
        // ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        updateDataViewer();
      } catch (e) {
        showNotification(`âš ï¸ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelDataEdit(key) {
      // ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¦ç·¨é›†å†…å®¹ã‚’ç ´æ£„
      updateDataViewer();
      showNotification('ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'info');
    }
    
    // é€šçŸ¥ã‚’è¡¨ç¤º
    function showNotification(message, type = 'info') {
      // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
      const existingNotif = document.getElementById('data-notification');
      if (existingNotif) {
        existingNotif.remove();
      }
      
      // è‰²ã‚’è¨­å®š
      let bgColor = '#333';
      switch (type) {
        case 'success': bgColor = '#4CAF50'; break;
        case 'error': bgColor = '#F44336'; break;
        case 'info': bgColor = '#2196F3'; break;
      }
      
      // é€šçŸ¥è¦ç´ ã‚’ä½œæˆ
      const notif = document.createElement('div');
      notif.id = 'data-notification';
      notif.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem;
        background: ${bgColor};
        color: white;
        border-radius: 8px;
        z-index: 2000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        animation: fadeInOut 3s forwards;
      `;
      notif.textContent = message;
      
      // é€šçŸ¥ã‚’è¿½åŠ 
      document.body.appendChild(notif);
      
      // 3ç§’å¾Œã«å‰Šé™¤
      setTimeout(() => {
        notif.remove();
      }, 3000);
    }

    // æ—¢å­˜ã®ä¼šè©±å±¥æ­´ã‚’ä¿®å¾©ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ 
    function repairChatHistory() {
      try {
        let history = JSON.parse(dataStore.getItem("chat_history") || "[]");
        let repaired = false;
        
        // å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
        history = history.map(message => {
          if (typeof message.content === "string" && 
              message.content.includes('{') && 
              message.content.includes('"reply":')) {
            
            try {
              // replyéƒ¨åˆ†ã‚’æŠ½å‡º
              const replyMatch = message.content.match(/"(reply|response)"\s*:\s*"([^"]*)"/);
              if (replyMatch && replyMatch[2]) {
                repaired = true;
                return {
                  ...message,
                  content: replyMatch[2]
                };
              }
            } catch (e) {
              console.warn("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿®å¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼:", e);
            }
          }
          return message;
        });
        
        if (repaired) {
          dataStore.setItem("chat_history", JSON.stringify(history));
          console.log("ä¼šè©±å±¥æ­´ã‚’ä¿®å¾©ã—ã¾ã—ãŸ");
        }
      } catch (e) {
        console.error("ä¼šè©±å±¥æ­´ã®ä¿®å¾©ã«å¤±æ•—:", e);
      }
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç®¡ç†ã®ãŸã‚ã®é–¢æ•°ç¾¤
    const errorLogger = {
      // æœ€å¤§ä¿å­˜æ•°
      MAX_LOGS: 10,
      
      // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ä¿å­˜
      logError: function(error, context = {}) {
        try {
          // ç¾åœ¨ã®ãƒ­ã‚°ã‚’å–å¾—
          let logs = JSON.parse(dataStore.getItem("error_logs") || "[]");
          
          // æ–°ã—ã„ãƒ­ã‚°ã‚’ä½œæˆ
          const newLog = {
            timestamp: new Date().toISOString(),
            error: error instanceof Error ? error.toString() : String(error),
            stack: error instanceof Error ? error.stack : null,
            context: context
          };
          
          // ãƒ­ã‚°ã‚’è¿½åŠ ï¼ˆå…ˆé ­ã«ï¼‰
          logs.unshift(newLog);
          
          // æœ€å¤§æ•°ã‚’è¶…ãˆãŸå ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
          if (logs.length > this.MAX_LOGS) {
            logs = logs.slice(0, this.MAX_LOGS);
          }
          
          // ä¿å­˜
          dataStore.setItem("error_logs", JSON.stringify(logs));
          
          // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒã‚ªãƒ³ãªã‚‰ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤ºã‚’æ›´æ–°
          if (isDebugMode()) {
            this.updateErrorLogDisplay();
          }
        } catch (e) {
          console.error("ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ä¿å­˜ã«å¤±æ•—:", e);
        }
      },
      
      // ãƒ­ã‚°è¡¨ç¤ºã‚’æ›´æ–°
      updateErrorLogDisplay: function() {
        try {
          const logArea = document.getElementById("errorLogArea");
          const logContent = document.getElementById("errorLogContent");
          
          // ãƒ­ã‚°ãŒç©ºãªã‚‰éè¡¨ç¤º
          const logs = JSON.parse(dataStore.getItem("error_logs") || "[]");
          if (logs.length === 0) {
            logArea.style.display = "none";
            return;
          }
          
          // è¡¨ç¤ºã‚’æ›´æ–°
          logArea.style.display = "block";
          
          // ãƒ­ã‚°å†…å®¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          let html = "";
          logs.forEach((log, index) => {
            const date = new Date(log.timestamp).toLocaleString();
            html += `<div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333;">`;
            html += `<div style="color: #ff6b6b; margin-bottom: 5px;">[${date}] ${log.error}</div>`;
            
            if (log.context) {
              // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
              html += `<div style="margin: 5px 0; color: #aaa;">ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:</div>`;
              html += `<div style="margin-left: 10px; color: #8bc34a;">`;
              
              // APIå¿œç­”
              if (log.context.apiResponse) {
                html += `<div style="margin-bottom: 5px;"><strong>APIå¿œç­”:</strong> `;
                try {
                  const resp = typeof log.context.apiResponse === 'string' 
                    ? JSON.parse(log.context.apiResponse) 
                    : log.context.apiResponse;
                  html += JSON.stringify(resp, null, 2).substring(0, 300);
                  if (JSON.stringify(resp).length > 300) html += "...";
                } catch (e) {
                  html += String(log.context.apiResponse).substring(0, 300);
                  if (String(log.context.apiResponse).length > 300) html += "...";
                }
                html += `</div>`;
              }
              
              // ç”Ÿã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
              if (log.context.rawResponse) {
                html += `<div style="margin-bottom: 5px;"><strong>ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹:</strong> `;
                html += `<span style="color: #e0e0e0;">${String(log.context.rawResponse).substring(0, 300)}</span>`;
                if (String(log.context.rawResponse).length > 300) html += "...";
                html += `</div>`;
              }
              
              // ãƒ‘ãƒ¼ã‚¹çµæœ
              if (log.context.parsedData) {
                html += `<div style="margin-bottom: 5px;"><strong>ãƒ‘ãƒ¼ã‚¹çµæœ:</strong> `;
                html += `<span style="color: #e0e0e0;">${JSON.stringify(log.context.parsedData, null, 2).substring(0, 300)}</span>`;
                if (JSON.stringify(log.context.parsedData).length > 300) html += "...";
                html += `</div>`;
              }
              
              html += `</div>`;
            }
            
            // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
            if (log.stack) {
              html += `<div style="margin-top: 5px; color: #aaa; font-size: 0.8rem;">${log.stack}</div>`;
            }
            
            html += `</div>`;
          });
          
          logContent.innerHTML = html || "ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“";
        } catch (e) {
          console.error("ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¡¨ç¤ºã®æ›´æ–°ã«å¤±æ•—:", e);
        }
      },
      
      // ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
      clearLogs: function() {
        dataStore.setItem("error_logs", "[]");
        this.updateErrorLogDisplay();
      }
    };
    
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
    function clearErrorLogs() {
      if (confirm("ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) {
        errorLogger.clearLogs();
      }
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    function copyErrorLogs() {
      try {
        const logs = JSON.parse(dataStore.getItem("error_logs") || "[]");
        if (logs.length === 0) {
          alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }
        
        const text = JSON.stringify(logs, null, 2);
        navigator.clipboard.writeText(text)
          .then(() => alert("ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"))
          .catch(err => {
            console.error("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:", err);
            alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
          });
      } catch (e) {
        alert("ã‚¨ãƒ©ãƒ¼: " + e);
      }
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ã‚’è¿½åŠ 
    function escapeHtml(text) {
      if (!text) return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ãƒ•ã‚©ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
    function togglePhotoMode() {
      const body = document.body;
      body.classList.toggle('photo-mode');
      
      // èƒŒæ™¯ç”»åƒã®è¡¨ç¤ºã‚’èª¿æ•´
      const characterBg = document.getElementById('character-bg');
      if (body.classList.contains('photo-mode')) {
        // ãƒ•ã‚©ãƒˆãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹æ™‚
        characterBg.style.opacity = "1";
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¨­å®šã‚’ä¿å­˜
        dataStore.setItem("photo_mode", "1");
        
        // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
        document.querySelector('.photo-mode-toggle').style.background = "#2196F3";
      } else {
        // ãƒ•ã‚©ãƒˆãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹æ™‚
        characterBg.style.opacity = "0.2";
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¨­å®šã‚’ä¿å­˜
        dataStore.setItem("photo_mode", "0");
        
        // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å…ƒã«æˆ»ã™
        document.querySelector('.photo-mode-toggle').style.background = "#444";
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†é–¢æ•°
    function handleFileSelect(input) {
      const fileInfo = document.getElementById("selectedFileInfo");
      if (input.files && input.files[0]) {
        const fileName = input.files[0].name;
        fileInfo.innerHTML = `é¸æŠä¸­: ${fileName} <span style="color: #4CAF50;">âœ“</span>`;
        fileInfo.style.display = "block";
      } else {
        fileInfo.innerHTML = "";
        fileInfo.style.display = "none";
      }
    }

    const bgInput = document.getElementById("backgroundInput");

    // --- èµ·å‹•æ™‚ã«èƒŒæ™¯ã‚’å¾©å…ƒ ---
    window.addEventListener("DOMContentLoaded", () => {
      // ã“ã®éƒ¨åˆ†ã¯å‰Šé™¤ã—ã¦ã€dataStore.initializeFromServer()ã«ç§»å‹•æ¸ˆã¿
      // GASã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–ã•ã‚Œã‚‹ãŸã‚ä¸è¦
    });

    // --- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«base64ä¿å­˜ï¼†èƒŒæ™¯å¤‰æ›´ ---
    bgInput.addEventListener("change", () => {
      const file = bgInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const base64 = e.target.result;
        document.getElementById("character-bg").src = base64;
        
        // ä¸¡æ–¹ã«ä¿å­˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã¨ã‚µãƒ¼ãƒãƒ¼ä¸¡æ–¹ï¼‰
        dataStore.setLocalItem("bgImageData", base64);
        dataStore.setItem("avatar_url", base64);
        
        // ä¿å­˜æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const fileInfo = document.getElementById("selectedFileInfo");
        if (fileInfo) {
          fileInfo.innerHTML = `<span style="color: #4CAF50;">âœ“ ç”»åƒãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</span>`;
          fileInfo.style.display = "block";
        }
      };
      reader.readAsDataURL(file);
    });
    
    // ã‚¹ãƒãƒ›ã§ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒªå†èµ·å‹•æ™‚ã®èƒŒæ™¯æ¶ˆå¤±ãƒã‚°å¯¾ç­–
    window.addEventListener("pageshow", (event) => {
      // ãƒšãƒ¼ã‚¸ãŒãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒã•ã‚ŒãŸå ´åˆã‚‚å«ã‚€
      if (event.persisted) {
        console.log("ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒã•ã‚Œã¾ã—ãŸ");
        
        // èƒŒæ™¯ç”»åƒã‚’å†é©ç”¨ï¼ˆå„ªå…ˆé †ä½: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ â†’ ã‚µãƒ¼ãƒãƒ¼ï¼‰
        const savedBg = localStorage.getItem("bgImageData");
        if (savedBg) {
          document.getElementById("character-bg").src = savedBg;
        } else {
          // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ä¿ƒã™
          dataStore._fetchAsync("avatar_url");
        }
      }
    });
    
    // ç”»é¢èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«èƒŒæ™¯ç”»åƒã‚’å¼·åˆ¶å¾©å…ƒï¼ˆã“ã®é–¢æ•°ã¯å‰Šé™¤ã€åˆæœŸåŒ–å‡¦ç†ã«çµ±åˆï¼‰
    // window.addEventListener('load', () => {
    //   // ãƒšãƒ¼ã‚¸å…¨ä½“ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸæ™‚ç‚¹ã§å®Ÿè¡Œ
    //   const savedImage = localStorage.getItem("bgImageData");
    //   if (savedImage) {
    //     document.getElementById("character-bg").src = savedImage;
    //     console.log("ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº†æ™‚ã«èƒŒæ™¯ç”»åƒã‚’å¼·åˆ¶å¾©å…ƒã—ã¾ã—ãŸ");
    //   }
    // });

    // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åˆæœŸå€¤ã¨è“„ç©å€¤ã‚’ç®¡ç†ã™ã‚‹é–¢æ•°ã‚’è¿½åŠ 
    function saveEmotionInitialValues(affection, trust, friendship) {
      try {
        const initialValues = {
          affection: parseInt(affection) || 0,
          trust: parseInt(trust) || 0,
          friendship: parseInt(friendship) || 0
        };
        dataStore.setItem('emotionInitialValues', JSON.stringify(initialValues));
        console.log('æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åˆæœŸå€¤ã‚’ä¿å­˜:', initialValues);
      } catch (e) {
        console.error('æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åˆæœŸå€¤ã®ä¿å­˜ã«å¤±æ•—:', e);
      }
    }
    
    function getEmotionInitialValues() {
      try {
        const savedValues = dataStore.getItem('emotionInitialValues');
        if (savedValues) {
          return JSON.parse(savedValues);
        }
      } catch (e) {
        console.error('æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åˆæœŸå€¤ã®å–å¾—ã«å¤±æ•—:', e);
      }
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      return {
        affection: 0,
        trust: 0,
        friendship: 0
      };
    }
    
    function calculateAccumulatedValues() {
      // ç¾åœ¨ã®å€¤ã‚’å–å¾—
      const currentAffection = parseInt(dataStore.getItem("affection") || "0");
      const currentTrust = parseInt(dataStore.getItem("trust") || "0");
      const currentFriendship = parseInt(dataStore.getItem("friendship") || "0");
      
      // åˆæœŸå€¤ã‚’å–å¾—
      const initialValues = getEmotionInitialValues();
      
      // è“„ç©å€¤ã‚’è¨ˆç®—
      const accumulatedValues = {
        affection: currentAffection - initialValues.affection,
        trust: currentTrust - initialValues.trust,
        friendship: currentFriendship - initialValues.friendship
      };
      
      console.log('è“„ç©æ„Ÿæƒ…å€¤ã‚’è¨ˆç®—:', accumulatedValues);
      return accumulatedValues;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
    function resetMessagesOnly() {
      if (!confirm("ä¼šè©±å±¥æ­´ã¨æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ã‚¿ã®ã¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã‚­ãƒ£ãƒ©è¨­å®šãƒ»ç”»åƒãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã¯ä¿æŒã•ã‚Œã¾ã™ã€‚")) return;
      
      // ä¿å­˜ã—ã¦ãŠãã¹ããƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const characterPrompt = dataStore.getItem("character_prompt");
      const charSelf = dataStore.getItem("char_self");
      const avatarUrl = dataStore.getItem("avatar_url");
      const apiKey = dataStore.getItem("openai_api_key");
      const storyMode = dataStore.getItem("story_mode");
      
      // ãƒªã‚»ãƒƒãƒˆå¯¾è±¡ã®ã‚­ãƒ¼ã‚’ç‰¹å®šï¼ˆã‚­ãƒ£ãƒ©è¨­å®šãƒ»ç”»åƒãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šä»¥å¤–ï¼‰
      const resetKeys = [
        "chat_history", "chat_story", "memory_counter", "last_keywords", 
        "affection", "trust", "friendship", "last_emotion_delta",
        "short_term_memory", "known_facts", "recent_dialogue_compressed"
      ];
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã®ä¸¡æ–¹ã‚’ã‚¯ãƒªã‚¢
      resetKeys.forEach(key => {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
        if (dataStore.cache) {
          dataStore.cache[key] = null;
        }
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã‚’ã‚¯ãƒªã‚¢ï¼ˆå®Ÿéš›ã«nullã‚’è¨­å®šï¼‰
        dataStore.setItem(key, null);
      });
      
      // chat_storyã¯ç©ºã®é…åˆ—ã¨ã—ã¦å†åˆæœŸåŒ–ï¼ˆnullã§ã¯ãªã[]ï¼‰
      dataStore.setItem("chat_story", "[]");
      if (dataStore.cache) {
        dataStore.cache["chat_story"] = "[]";
      }
      
      // ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å†è¨­å®š
      if (characterPrompt) dataStore.setItem("character_prompt", characterPrompt);
      if (charSelf) dataStore.setItem("char_self", charSelf);
      if (avatarUrl) dataStore.setItem("avatar_url", avatarUrl);
      if (apiKey) dataStore.setItem("openai_api_key", apiKey);
      if (storyMode) dataStore.setItem("story_mode", storyMode);
      
      // å¤‰æ›´ã‚’ã‚µãƒ¼ãƒãƒ¼ã«åæ˜ 
      dataStore.flushChanges();
      
      // UIæ›´æ–°
      updateUIAfterReset();
    }
    
    // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é–¢æ•°ï¼ˆå…±é€šåŒ–ã®ãŸã‚é–¢æ•°ã¨ã—ã¦åˆ‡ã‚Šå‡ºã—ï¼‰
    function scaleEmotionValue(delta) {
      // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é–¢æ•°ã®å®Ÿè£…
      const absDelta = Math.abs(delta);
      let scaleFactor = 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¿‚æ•°
      
      if (absDelta <= 2) {
        scaleFactor = 3;
      } else if (absDelta <= 4) {
        scaleFactor = 2.5;
      } else {
        scaleFactor = 2;
      }
      
      // å…ƒã®ç¬¦å·ã‚’ä¿æŒã—ãŸã¾ã¾ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
      let scaledDelta = delta * scaleFactor;
      
      // Â±25ã‚’ä¸Šé™ã¨ã™ã‚‹
      const limitedDelta = Math.max(-25, Math.min(25, scaledDelta));
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°å‡ºåŠ›
      console.log(`ğŸ§® æ„Ÿæƒ…ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°: ${delta} (abs: ${absDelta}) Ã— ${scaleFactor} = ${scaledDelta} â†’ ${limitedDelta}`);
      
      return limitedDelta;
    }

    // ã‚­ãƒ£ãƒ©ãŒã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ãƒªãƒ¼ãƒ‰ã™ã‚‹ç¢ºç‡ã®æ›´æ–°
    function updateStoryLeadProbability(value) {
      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’ä¿å­˜
      dataStore.setItem("story_lead_probability", value);
      
      // è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById("storyLeadValue").textContent = value + "%";
    }
    
    // ã‚­ãƒ£ãƒ©ãŒã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ãƒªãƒ¼ãƒ‰ã™ã‚‹ç¢ºç‡ã®çŠ¶æ…‹ã‚’åæ˜ 
    function applyStoryLeadProbability() {
      // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å€¤ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯75%ï¼‰
      const probability = dataStore.getItem("story_lead_probability") || "75";
      
      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’è¨­å®š
      document.getElementById("storyLeadSlider").value = probability;
      
      // è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById("storyLeadValue").textContent = probability + "%";
    }
    
    // æ—¢çŸ¥æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºåˆ‡æ›¿
    function toggleKnownFactsModal() {
      const modal = document.getElementById("knownFactsModal");
      if (modal.style.display === "none") {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        modal.style.display = "block";
        
        // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
        const knownFacts = dataStore.getItem("known_facts") || "";
        document.getElementById("knownFactsInput").value = knownFacts;
      } else {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        modal.style.display = "none";
      }
    }
    
    // æ—¢çŸ¥æƒ…å ±ã‚’ä¿å­˜
    function saveKnownFacts() {
      const knownFacts = document.getElementById("knownFactsInput").value.trim();
      dataStore.setItem("known_facts", knownFacts);
      
      // å¤‰æ›´ã‚’å³æ™‚ä¿å­˜
      dataStore.flushChanges();
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      toggleKnownFactsModal();
      
      // ä¿å­˜æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      alert("æ—¢çŸ¥æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
    }
    
    // æ—¢çŸ¥æƒ…å ±ã‚’å–å¾—
    function getKnownFacts() {
      return dataStore.getItem("known_facts") || "";
    }

    // å†ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showRegenPromptModal() {
      const modal = document.getElementById("regenerateModal");
      document.getElementById("regenPrompt").value = "";
      modal.style.display = "flex";
      
      // å†ç”Ÿæˆã®ãŸã‚ã«ç¾åœ¨ã®ç‰©èªå±•é–‹ãƒ’ãƒ³ãƒˆã‚’ä¿å­˜
      saveForRegeneration();
    }
    
    // å†ç”Ÿæˆç”¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€å¾Œã®å…¥åŠ›ã¨ç‰©èªå±•é–‹ãƒ’ãƒ³ãƒˆã‚’ä¿å­˜
    function saveForRegeneration() {
      // æœ€å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
      const history = JSON.parse(dataStore.getItem("chat_history") || "[]");
      const userMessages = history.filter(m => m.role === "user");
      const lastUserMessage = userMessages.length > 0 ? userMessages[userMessages.length - 1].content : "";

      // ä¿å­˜
      dataStore.setItem("last_user_message", lastUserMessage);
      
      // æ¬¡å›ã®å†ç”Ÿæˆã§åŒã˜ãƒ—ãƒ­ãƒƒãƒˆãƒ’ãƒ³ãƒˆã‚’ä½¿ã†ãŸã‚ä¸€æ™‚ä¿å­˜
      const currentPlotHint = dataStore.getItem("next_plot_hint");
      if (currentPlotHint) {
        dataStore.setItem("regen_plot_hint", currentPlotHint);
      }
      
      // æ„Ÿæƒ…å¤‰å‹•ã®ãƒªã‚»ãƒƒãƒˆç”¨
      const lastEmotionDelta = dataStore.getItem("last_emotion_delta");
      if (lastEmotionDelta) {
        try {
          const delta = JSON.parse(lastEmotionDelta);
          
          // ç›¸æ®ºç”¨ã«åè»¢
          if (delta.affection) updateParam("affection", -delta.affection);
          if (delta.trust) updateParam("trust", -delta.trust);
          if (delta.friendship) updateParam("friendship", -delta.friendship);
        } catch (e) {
          console.error("æ„Ÿæƒ…å€¤ç›¸æ®ºã‚¨ãƒ©ãƒ¼:", e);
        }
      }
    }

    // å†ç”Ÿæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å®Ÿè¡Œãƒœã‚¿ãƒ³
    async function executeRegeneration() {
      try {
        const userPrompt = document.getElementById("regenPrompt").value.trim();
        if (userPrompt) {
          window.userPromptOverride = userPrompt;
        } else {
          window.userPromptOverride = null;
        }
        
        // ä¼šè©±å±¥æ­´ã‹ã‚‰æœ€å¾Œã®ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        const history = JSON.parse(dataStore.getItem("chat_history") || "[]");
        let lastUserMessage = "";
        
        for (let i = history.length - 1; i >= 0; i--) {
          if (history[i].role === "assistant") {
            history.splice(i, 1);
            continue;
          }
          if (history[i].role === "user" && !lastUserMessage) {
            lastUserMessage = history[i].content;
            break;
          }
        }
        
        // å±¥æ­´ã‚’ä¿å­˜ã—ã¦æ›´æ–°
        dataStore.setItem("chat_history", JSON.stringify(history));
        loadHistory();
        
        // å†ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã§é€ä¿¡
        await sendMessage(true);
        
        // å¾Œå‡¦ç†
        window.userPromptOverride = null;
        document.getElementById("regenerateModal").style.display = "none";
      } catch (e) {
        console.error("å†ç”Ÿæˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:", e);
        alert("å†ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
      }
    }

    // GPT-4oãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
    function clearGpt4oLogs() {
      dataStore.setItem("gpt4o_logs", "[]");
      document.getElementById("gpt4oLogsContent").textContent = "ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“";
      updateGpt4oLogsDisplay();
    }

    // GPT-4oãƒ­ã‚°ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateGpt4oLogsDisplay() {
      const logs = JSON.parse(dataStore.getItem("gpt4o_logs") || "[]");
      let logContent = "";
      logs.forEach((log, index) => {
        logContent += `<div style="margin-bottom: 5px;">${log.date}: ${log.suggestion}</div>`;
      });
      document.getElementById("gpt4oLogsContent").innerHTML = logContent || "ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“";
    }

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
    document.addEventListener("DOMContentLoaded", function() {
      // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
      dataStore.initializeFromServer();
      
      // è¨­å®šã®èª­ã¿è¾¼ã¿
      loadSettingsFromStore();
      
      // å±¥æ­´ã®èª­ã¿è¾¼ã¿
      loadHistory();
      
      // æ„Ÿæƒ…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¡¨ç¤º
      renderEmotionParams();
      
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šã‚’åæ˜ 
      applyStoryMode();
      
      // GPT-4oã®ãƒ­ã‚°è¡¨ç¤ºã‚’æ›´æ–°
      updateGpt4oLogsDisplay();
      
      // ç”»åƒã®èª­ã¿è¾¼ã¿
      const savedImageData = dataStore.getLocalItem("bgImageData");
      if (savedImageData) {
        document.getElementById("character-bg").src = savedImageData;
      } else {
        const avatarUrl = dataStore.getItem("avatar_url");
        if (avatarUrl) {
          document.getElementById("character-bg").src = avatarUrl;
        }
      }
      
      // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å¼·åˆ¶çš„ã«è¡¨ç¤ºï¼ˆè¿½åŠ ï¼‰
      setTimeout(() => {
        const sliderContainer = document.querySelector('#storyIntensitySelector > div:last-child');
        if (sliderContainer) {
          sliderContainer.style.display = "block";
        }
        // ç‰©èªå±•é–‹ç¢ºç‡ãƒãƒ¼ã‚‚ç¢ºå®Ÿã«è¡¨ç¤º
        const storyLeadSlider = document.getElementById("storyLeadSlider");
        if (storyLeadSlider) {
          storyLeadSlider.style.display = "block";
        }
        applyStoryLeadProbability();
      }, 100);
    });

    // è¨­å®šã‚’ã‚¹ãƒˆã‚¢ã‹ã‚‰èª­ã¿è¾¼ã‚€é–¢æ•°
    function loadSettingsFromStore() {
      // UIè¦ç´ ã‚’æ›´æ–°
      const apiKey = dataStore.getItem("openai_api_key");
      const characterPrompt = dataStore.getItem("character_prompt");
      const charSelf = dataStore.getItem("char_self");
      const storyMode = dataStore.getItem("story_mode") || "1"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ON

      // å€¤ã‚’è¨­å®š
      if (apiKey) document.getElementById("apiKey").value = apiKey;
      if (characterPrompt) document.getElementById("charPrompt").value = characterPrompt;
      if (charSelf) document.getElementById("charSelfSetting").value = charSelf;

      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰
      document.getElementById("storyModeToggle").checked = storyMode === "1";
      
      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’æ›´æ–°
      updateStoryMode();
    }
  </script>
</body>

</html> 